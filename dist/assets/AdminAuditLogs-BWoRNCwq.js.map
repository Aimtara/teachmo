{"version":3,"file":"AdminAuditLogs-BWoRNCwq.js","sources":["../../src/pages/AdminAuditLogs.jsx"],"sourcesContent":["import { useMemo, useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { format } from 'date-fns';\nimport { nhost } from '@/lib/nhostClient';\nimport { graphql } from '@/lib/graphql';\nimport { useTenantScope } from '@/hooks/useTenantScope';\nimport { createLogger } from '@/utils/logger';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\n\nconst logger = createLogger('admin-audit-logs');\n\nexport default function AdminAuditLogs() {\n  const { data: scope } = useTenantScope();\n  const organizationId = scope?.organizationId ?? null;\n  const schoolId = scope?.schoolId ?? null;\n  const [search, setSearch] = useState('');\n\n  const auditQuery = useQuery({\n    queryKey: ['audit-log', organizationId, schoolId],\n    enabled: Boolean(organizationId),\n    queryFn: async () => {\n      const query = `query AuditLog($where: audit_log_bool_exp!, $limit: Int!) {\n        audit_log(where: $where, order_by: { created_at: desc }, limit: $limit) {\n          id\n          created_at\n          actor_id\n          action\n          entity_type\n          entity_id\n          metadata\n          organization_id\n          school_id\n        }\n      }`;\n\n      const where = schoolId\n        ? { school_id: { _eq: schoolId } }\n        : { organization_id: { _eq: organizationId } };\n\n      const res = await graphql(query, { where, limit: 200 });\n      return res?.audit_log ?? [];\n    },\n  });\n\n  const filtered = useMemo(() => {\n    const term = search.trim().toLowerCase();\n    if (!term) return auditQuery.data ?? [];\n    return (auditQuery.data ?? []).filter((row) => {\n      return (\n        row.action?.toLowerCase().includes(term) ||\n        row.entity_type?.toLowerCase().includes(term)\n      );\n    });\n  }, [auditQuery.data, search]);\n\n  const exportCsv = async () => {\n    const { res, error } = await nhost.functions.call('audit-export', {\n      search,\n      organizationId,\n      schoolId,\n    });\n\n    if (error) {\n      logger.error('Audit export failed', error);\n      return;\n    }\n\n    const blob = await res.blob();\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `audit-logs-${new Date().toISOString().slice(0, 10)}.csv`;\n    document.body.appendChild(link);\n    link.click();\n    link.remove();\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\">Audit Logs</h1>\n        <p className=\"text-sm text-muted-foreground\">\n          View immutable audit records for security-sensitive activity. Filters apply to your tenant scope.\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Search & Export</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-col gap-3 md:flex-row md:items-center md:justify-between\">\n          <Input\n            value={search}\n            onChange={(event) => setSearch(event.target.value)}\n            placeholder=\"Filter by action or entity\"\n            className=\"md:max-w-sm\"\n          />\n          <Button onClick={exportCsv} disabled={!organizationId}>\n            Export CSV\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Recent Entries</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Date</TableHead>\n                <TableHead>Action</TableHead>\n                <TableHead>Entity</TableHead>\n                <TableHead>Actor</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filtered.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={4} className=\"text-sm text-muted-foreground\">\n                    No audit records found.\n                  </TableCell>\n                </TableRow>\n              ) : (\n                filtered.map((row) => (\n                  <TableRow key={row.id}>\n                    <TableCell className=\"whitespace-nowrap\">\n                      {row.created_at ? format(new Date(row.created_at), 'MMM d, yyyy p') : 'â€”'}\n                    </TableCell>\n                    <TableCell>{row.action}</TableCell>\n                    <TableCell>{row.entity_type}</TableCell>\n                    <TableCell className=\"font-mono text-xs\">\n                      {row.actor_id ?? 'system'}\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":["logger","createLogger","AdminAuditLogs","scope","useTenantScope","organizationId","schoolId","search","setSearch","useState","auditQuery","useQuery","res","graphql","filtered","useMemo","term","row","_a","_b","exportCsv","error","nhost","blob","url","link","jsxs","jsx","Card","CardHeader","CardTitle","CardContent","Input","event","Button","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","format"],"mappings":"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"}