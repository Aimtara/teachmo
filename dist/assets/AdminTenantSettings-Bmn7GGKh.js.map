{"version":3,"file":"AdminTenantSettings-Bmn7GGKh.js","sources":["../../src/pages/AdminTenantSettings.jsx"],"sourcesContent":["import { useMemo, useState } from 'react';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { graphql } from '@/lib/graphql';\nimport { useTenantScope } from '@/hooks/useTenantScope';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Switch } from '@/components/ui/switch';\n\nfunction safeJsonParse(txt) {\n  try {\n    return txt ? JSON.parse(txt) : {};\n  } catch {\n    return {};\n  }\n}\n\nexport default function AdminTenantSettings() {\n  const { data: scope } = useTenantScope();\n  const districtId = scope?.districtId ?? null;\n  const schoolId = scope?.schoolId ?? null;\n\n  const settingsQuery = useQuery({\n    queryKey: ['tenant_settings', districtId, schoolId],\n    enabled: !!districtId,\n    queryFn: async () => {\n      const query = `query TenantSettings($districtId: uuid!, $schoolId: uuid) {\n        tenant_settings(\n          where: {\n            district_id: { _eq: $districtId },\n            _or: [\n              { school_id: { _eq: $schoolId } },\n              { school_id: { _is_null: true } }\n            ]\n          },\n          order_by: { school_id: desc_nulls_last }\n        ) {\n          id\n          district_id\n          school_id\n          name\n          branding\n          settings\n          updated_at\n        }\n      }`;\n\n      const res = await graphql.request(query, { districtId, schoolId });\n      return res.tenant_settings?.[0] ?? null;\n    },\n  });\n\n  const [name, setName] = useState('');\n  const [logoUrl, setLogoUrl] = useState('');\n  const [primaryColor, setPrimaryColor] = useState('#111827');\n  const [accentColor, setAccentColor] = useState('#3b82f6');\n  const [settingsJson, setSettingsJson] = useState('{}');\n  const [auditLogRetentionDays, setAuditLogRetentionDays] = useState('365');\n  const [dsarRetentionDays, setDsarRetentionDays] = useState('30');\n  const [requireSso, setRequireSso] = useState(false);\n\n  useMemo(() => {\n    const row = settingsQuery.data;\n    if (!row) return;\n    setName(row.name ?? '');\n    setLogoUrl(row.branding?.logo_url ?? '');\n    setPrimaryColor(row.branding?.primary_color ?? '#111827');\n    setAccentColor(row.branding?.accent_color ?? '#3b82f6');\n    const settings = row.settings ?? {};\n    const retention = settings.retention ?? {};\n    setAuditLogRetentionDays(String(retention.audit_log_days ?? retention.auditLogDays ?? '365'));\n    setDsarRetentionDays(String(retention.dsar_export_days ?? retention.dsarExportDays ?? '30'));\n    setSettingsJson(JSON.stringify(settings, null, 2));\n    const requireFlag =\n      settings.require_sso !== undefined\n        ? settings.require_sso\n        : settings.requireSso !== undefined\n        ? settings.requireSso\n        : false;\n    setRequireSso(Boolean(requireFlag));\n  }, [settingsQuery.data]);\n\n  const saveMutation = useMutation({\n    mutationFn: async () => {\n      if (!districtId) throw new Error('Missing district scope');\n      const branding = {\n        logo_url: logoUrl || null,\n        primary_color: primaryColor || null,\n        accent_color: accentColor || null,\n      };\n      const settings = safeJsonParse(settingsJson);\n      settings.retention = {\n        ...settings.retention,\n        audit_log_days: Number(auditLogRetentionDays) || 365,\n        dsar_export_days: Number(dsarRetentionDays) || 30,\n      };\n      // Persist the require_sso flag (use snake_case for consistency)\n      settings.require_sso = Boolean(requireSso);\n\n      if (settingsQuery.data?.id) {\n        const m = `mutation UpdateTenantSettings($id: uuid!, $changes: tenant_settings_set_input!) {\n          update_tenant_settings_by_pk(pk_columns: { id: $id }, _set: $changes) { id updated_at }\n        }`;\n        await graphql.request(m, {\n          id: settingsQuery.data.id,\n          changes: { name, branding, settings },\n        });\n      } else {\n        const m = `mutation InsertTenantSettings($object: tenant_settings_insert_input!) {\n          insert_tenant_settings_one(object: $object) { id }\n        }`;\n        await graphql.request(m, {\n          object: { district_id: districtId, school_id: schoolId, name, branding, settings },\n        });\n      }\n    },\n    onSuccess: () => settingsQuery.refetch(),\n  });\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\">Tenant Settings</h1>\n        <p className=\"text-sm text-muted-foreground\">\n          Configure district / school-level branding and settings. Stored in Hasura + enforced with DB RLS.\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Scope</CardTitle>\n        </CardHeader>\n        <CardContent className=\"text-sm space-y-1\">\n          <div><span className=\"text-muted-foreground\">District:</span> <span className=\"font-mono\">{districtId ?? '—'}</span></div>\n          <div><span className=\"text-muted-foreground\">School:</span> <span className=\"font-mono\">{schoolId ?? '—'}</span></div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Branding</CardTitle>\n        </CardHeader>\n        <CardContent className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">Tenant name</div>\n            <Input value={name} onChange={(e) => setName(e.target.value)} placeholder=\"Paterson Public Schools\" />\n          </div>\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">Logo URL</div>\n            <Input value={logoUrl} onChange={(e) => setLogoUrl(e.target.value)} placeholder=\"https://.../logo.png\" />\n          </div>\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">Primary color</div>\n            <Input value={primaryColor} onChange={(e) => setPrimaryColor(e.target.value)} />\n          </div>\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">Accent color</div>\n            <Input value={accentColor} onChange={(e) => setAccentColor(e.target.value)} />\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Identity & SSO</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center space-x-2\">\n            <Switch\n              id=\"require-sso\"\n              checked={requireSso}\n              onCheckedChange={(checked) => setRequireSso(checked)}\n            />\n            <label htmlFor=\"require-sso\" className=\"text-sm\">\n              Require users to sign in via single sign-on\n            </label>\n          </div>\n          <p className=\"mt-1 text-xs text-muted-foreground\">\n            When enabled, all users will be redirected to an enabled SSO provider and email/password login will be disabled.\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Settings JSON</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Textarea value={settingsJson} onChange={(e) => setSettingsJson(e.target.value)} rows={10} />\n          <div className=\"mt-3 flex justify-end\">\n            <Button onClick={() => saveMutation.mutate()} disabled={saveMutation.isLoading || !districtId}>\n              {saveMutation.isLoading ? 'Saving…' : 'Save'}\n            </Button>\n          </div>\n          {saveMutation.error ? (\n            <div className=\"mt-2 text-sm text-red-600\">{String(saveMutation.error)}</div>\n          ) : null}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Retention Policy</CardTitle>\n        </CardHeader>\n        <CardContent className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">Audit log retention (days)</div>\n            <Input\n              type=\"number\"\n              min=\"1\"\n              value={auditLogRetentionDays}\n              onChange={(e) => setAuditLogRetentionDays(e.target.value)}\n            />\n          </div>\n          <div>\n            <div className=\"text-xs text-muted-foreground mb-1\">DSAR export retention (days)</div>\n            <Input\n              type=\"number\"\n              min=\"1\"\n              value={dsarRetentionDays}\n              onChange={(e) => setDsarRetentionDays(e.target.value)}\n            />\n          </div>\n          <p className=\"text-xs text-muted-foreground md:col-span-2\">\n            Retention settings override the JSON payload on save and are used by the automated purge job.\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":["safeJsonParse","txt","AdminTenantSettings","scope","useTenantScope","districtId","schoolId","settingsQuery","useQuery","_a","graphql","name","setName","useState","logoUrl","setLogoUrl","primaryColor","setPrimaryColor","accentColor","setAccentColor","settingsJson","setSettingsJson","auditLogRetentionDays","setAuditLogRetentionDays","dsarRetentionDays","setDsarRetentionDays","requireSso","setRequireSso","useMemo","row","_b","_c","settings","retention","requireFlag","saveMutation","useMutation","branding","jsxs","jsx","Card","CardHeader","CardTitle","CardContent","Input","e","Switch","checked","Textarea","Button"],"mappings":"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"}