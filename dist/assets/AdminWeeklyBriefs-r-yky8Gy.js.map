{"version":3,"file":"AdminWeeklyBriefs-r-yky8Gy.js","sources":["../../src/pages/AdminWeeklyBriefs.jsx"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\nimport { Link } from 'react-router-dom';\nimport { nhost } from '@/lib/nhostClient';\n\nfunction isoWeekStart(date = new Date()) {\n  const base = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));\n  const day = base.getUTCDay() || 7;\n  if (day !== 1) base.setUTCDate(base.getUTCDate() - (day - 1));\n  return base.toISOString().slice(0, 10);\n}\n\nexport default function AdminWeeklyBriefs() {\n  const defaultWeekStart = useMemo(() => isoWeekStart(new Date()), []);\n  const [weekStart, setWeekStart] = useState(defaultWeekStart);\n  const [dryRun, setDryRun] = useState(true);\n  const [loading, setLoading] = useState(false);\n  const [result, setResult] = useState(null);\n  const [error, setError] = useState('');\n  const [runs, setRuns] = useState([]);\n  const [runsLoading, setRunsLoading] = useState(false);\n\n  const fetchRuns = async () => {\n    setRunsLoading(true);\n    try {\n      const res = await nhost.functions.call('weekly-brief-runs-get', { limit: 10 });\n      if (res.error) throw res.error;\n      setRuns(res.data?.runs || []);\n    } catch (e) {\n      // Run history isn't critical for generation.\n    } finally {\n      setRunsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchRuns();\n  }, []);\n\n  const runGenerator = async () => {\n    setLoading(true);\n    setError('');\n    setResult(null);\n\n    try {\n      const res = await nhost.functions.call('generate-weekly-briefs', {\n        weekStart,\n        dryRun\n      });\n      if (res.error) throw res.error;\n      setResult(res.data);\n      fetchRuns();\n    } catch (e) {\n      setError(e?.message || 'Failed to run generator');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const runInsights = async () => {\n    setLoading(true);\n    setError('');\n    setResult(null);\n\n    try {\n      const res = await nhost.functions.call('insights-weekly', {\n        weekStart\n      });\n      if (res.error) throw res.error;\n      setResult(res.data);\n    } catch (e) {\n      setError(e?.message || 'Failed to load insights');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <header className=\"space-y-2\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <h1 className=\"text-3xl font-semibold\">Weekly Briefs</h1>\n          <Link to=\"/admin\" className=\"text-sm text-blue-700 hover:underline\">\n            Back to admin\n          </Link>\n        </div>\n        <p className=\"text-gray-600\">\n          Pilot tool: generate weekly briefs on demand (dry-run first), then publish.\n        </p>\n      </header>\n\n      {runs.length > 0 && (\n        <section className=\"bg-white rounded shadow p-4\">\n          <div className=\"flex items-center justify-between\">\n            <h2 className=\"font-medium\">Last generation run</h2>\n            <span className=\"text-xs text-gray-500\">{runsLoading ? 'Refreshing…' : ''}</span>\n          </div>\n          <div className=\"mt-2 text-sm text-gray-700 space-y-1\">\n            <div>\n              <span className=\"font-medium\">Status:</span> {runs[0].status}\n              {runs[0].dry_run ? ' (dry run)' : ''}\n            </div>\n            <div>\n              <span className=\"font-medium\">Week:</span> {String(runs[0].week_start_date)} →{' '}\n              {String(runs[0].week_end_date)}\n            </div>\n            <div>\n              <span className=\"font-medium\">Generated:</span> {runs[0].generated_count}\n            </div>\n            <div>\n              <span className=\"font-medium\">Started:</span>{' '}\n              {new Date(runs[0].started_at).toLocaleString()}\n            </div>\n            {runs[0].finished_at && (\n              <div>\n                <span className=\"font-medium\">Finished:</span>{' '}\n                {new Date(runs[0].finished_at).toLocaleString()}\n              </div>\n            )}\n            {runs[0].error && (\n              <div className=\"text-red-700\">\n                <span className=\"font-medium\">Error:</span> {runs[0].error}\n              </div>\n            )}\n          </div>\n        </section>\n      )}\n\n      <section className=\"bg-white rounded shadow p-4 space-y-4\">\n        <div className=\"grid grid-cols-1 gap-4 md:grid-cols-3\">\n          <label className=\"space-y-1\">\n            <span className=\"text-sm text-gray-700\">Week start (Mon)</span>\n            <input\n              type=\"date\"\n              value={weekStart}\n              onChange={(e) => setWeekStart(e.target.value)}\n              className=\"w-full border rounded px-3 py-2\"\n            />\n          </label>\n\n          <label className=\"flex items-center gap-2 mt-6\">\n            <input\n              type=\"checkbox\"\n              checked={dryRun}\n              onChange={(e) => setDryRun(e.target.checked)}\n            />\n            <span className=\"text-sm text-gray-700\">Dry run (do not write to DB)</span>\n          </label>\n        </div>\n\n        <div className=\"flex flex-wrap gap-3\">\n          <button\n            onClick={runGenerator}\n            disabled={loading}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-60\"\n          >\n            {loading ? 'Running…' : dryRun ? 'Run dry run' : 'Generate & publish'}\n          </button>\n\n          <button\n            onClick={runInsights}\n            disabled={loading}\n            className=\"bg-gray-900 text-white px-4 py-2 rounded disabled:opacity-60\"\n          >\n            {loading ? 'Loading…' : 'Load weekly insights'}\n          </button>\n        </div>\n\n        <p className=\"text-xs text-gray-500\">\n          Tip: Start with dry run to verify output, then uncheck dry run to publish. In production, schedule\n          <code className=\"px-1\">generate-weekly-briefs</code> via a cron.\n        </p>\n      </section>\n\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 text-red-800 rounded p-3 text-sm\">\n          {error}\n        </div>\n      )}\n\n      {result && (\n        <section className=\"bg-white rounded shadow p-4\">\n          <h2 className=\"font-medium mb-3\">Result</h2>\n          <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto\">\n            {JSON.stringify(result, null, 2)}\n          </pre>\n        </section>\n      )}\n    </div>\n  );\n}\n"],"names":["isoWeekStart","date","base","day","AdminWeeklyBriefs","defaultWeekStart","useMemo","weekStart","setWeekStart","useState","dryRun","setDryRun","loading","setLoading","result","setResult","error","setError","runs","setRuns","runsLoading","setRunsLoading","fetchRuns","res","nhost","_a","useEffect","runGenerator","e","runInsights","jsxs","jsx","Link"],"mappings":"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"}