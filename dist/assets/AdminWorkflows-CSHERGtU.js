import{r as j,j as e,C as O,i as D,k as T,o as J,B as b,b as Oe,G as F,a7 as R,y as k,t as A,n as ie}from"./index-BPP-_OMN.js";import{u as xe}from"./useMutation-CMiQkM4s.js";import{I as B}from"./input-DXyqFpUo.js";import{S,a as q,b as C,c as I,d as _}from"./select-45VgWSkf.js";import{T as $}from"./textarea-Be6YKw6o.js";import{T as De,a as Te,b as he,c as pe}from"./tabs-CMvz8dI1.js";import{D as Je,a as Ee,b as Ae,c as Ve}from"./dialog-Mb3rkrWD.js";import"./cn-2dOUpm6k.js";const fe=[{value:"create_entity",label:"Create entity"},{value:"update_entity",label:"Update entity"},{value:"condition",label:"Condition (branch)"},{value:"notify",label:"Notify (in-app)"},{value:"noop",label:"No-op"}],Fe=[{value:"eq",label:"Equals"},{value:"ne",label:"Not equals"},{value:"contains",label:"Contains"},{value:"ncontains",label:"Not contains"},{value:"gt",label:"Greater than"},{value:"gte",label:"Greater or equal"},{value:"lt",label:"Less than"},{value:"lte",label:"Less or equal"},{value:"exists",label:"Exists"}],Re=[{value:"",label:"(none)"},{value:"automation:manage",label:"automation:manage"},{value:"automation:run",label:"automation:run"},{value:"automation:replay",label:"automation:replay"},{value:"automation:request_review",label:"automation:request_review"},{value:"automation:approve",label:"automation:approve"},{value:"automation:publish",label:"automation:publish"},{value:"tenant:manage",label:"tenant:manage"},{value:"users:manage",label:"users:manage"},{value:"analytics:view",label:"analytics:view"},{value:"analytics:export",label:"analytics:export"}];function ve(o){var x;const u=o&&typeof o=="object"?o:{},l=(Array.isArray(u.steps)?u.steps:[]).map((c,y)=>({id:String(c.id||c.key||`step_${y+1}`),type:c.type||"noop",config:c.config&&typeof c.config=="object"?c.config:{},next:c.next??null,on_true:c.on_true??null,on_false:c.on_false??null})).filter(c=>c.id);return{version:2,start:typeof u.start=="string"?u.start:((x=l[0])==null?void 0:x.id)||null,steps:l}}function Q(o){try{return JSON.parse(o)}catch{return null}}function je({value:o,onChange:u,placeholderKey:f,placeholderValue:l}){const m=j.useMemo(()=>Object.entries(o&&typeof o=="object"?o:{}).map(([h,a])=>({k:h,v:typeof a=="string"?a:JSON.stringify(a)})),[o]),[x,c]=j.useState(m);j.useEffect(()=>c(m),[m]);const y=s=>{c(s);const h={};for(const a of s){const d=String(a.k||"").trim();d&&(h[d]=a.v)}u(h)};return e.jsxs("div",{className:"space-y-2",children:[x.map((s,h)=>e.jsxs("div",{className:"grid grid-cols-1 gap-2 sm:grid-cols-5",children:[e.jsx(B,{className:"sm:col-span-2",placeholder:f,value:s.k,onChange:a=>{const d=x.slice();d[h]={...d[h],k:a.target.value},y(d)}}),e.jsx(B,{className:"sm:col-span-2",placeholder:l,value:s.v,onChange:a=>{const d=x.slice();d[h]={...d[h],v:a.target.value},y(d)}}),e.jsx(b,{type:"button",variant:"outline",onClick:()=>{const a=x.slice();a.splice(h,1),y(a)},children:"Remove"})]},h)),e.jsx(b,{type:"button",variant:"secondary",onClick:()=>y([...x||[],{k:"",v:""}]),children:"Add mapping"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Tip: use templates like ",e.jsx("code",{children:"{{event_metadata.thread_id}}"})," or ",e.jsx("code",{children:"{{actor_user_id}}"}),"."]})]})}function Me({definitionJson:o,onChangeDefinitionJson:u}){const f=j.useMemo(()=>ve(Q(o)),[o]),[l,m]=j.useState(f);j.useEffect(()=>{m(f)},[f.start,f.steps.length]);const x=j.useMemo(()=>l.steps.map(a=>a.id),[l.steps]),c=a=>{const d=ve(a);m(d),u(JSON.stringify(d,null,2))},y=a=>{const v=`step_${l.steps.length+1}`,g={id:v,type:a,config:{},next:null,on_true:null,on_false:null};a==="condition"&&(g.config={left:"{{event_name}}",op:"eq",right:"some.event"});const p={...l,steps:[...l.steps,g]};p.start||(p.start=v),c(p)},s=(a,d)=>{const v=l.steps.map(g=>g.id===a?{...g,...d}:g);c({...l,steps:v})},h=a=>{var g;const d=l.steps.filter(p=>p.id!==a),v={...l,steps:d};v.start===a&&(v.start=((g=d[0])==null?void 0:g.id)||null),v.steps=v.steps.map(p=>({...p,next:p.next===a?null:p.next,on_true:p.on_true===a?null:p.on_true,on_false:p.on_false===a?null:p.on_false})),c(v)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(O,{children:[e.jsx(D,{children:e.jsx(T,{children:"Flow"})}),e.jsxs(J,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Start step"}),e.jsxs(S,{value:l.start||"",onValueChange:a=>c({...l,start:a||null}),children:[e.jsx(q,{children:e.jsx(C,{placeholder:"Select start"})}),e.jsx(I,{children:x.map(a=>e.jsx(_,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Add step"}),e.jsxs(S,{onValueChange:y,children:[e.jsx(q,{children:e.jsx(C,{placeholder:"Choose type"})}),e.jsx(I,{children:fe.map(a=>e.jsx(_,{value:a.value,children:a.label},a.value))})]})]})]}),!l.steps.length&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No steps yet. Add your first step above."}),e.jsx("div",{className:"space-y-4",children:l.steps.map(a=>{var d,v,g,p,V,Y;return e.jsxs(O,{className:"border-dashed",children:[e.jsx(D,{children:e.jsxs(T,{className:"flex items-center justify-between text-base",children:[e.jsxs("span",{children:[a.id," ",e.jsxs("span",{className:"text-muted-foreground",children:["· ",a.type]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(b,{type:"button",variant:"outline",size:"sm",onClick:()=>h(a.id),children:"Delete"})})]})}),e.jsxs(J,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Step type"}),e.jsxs(S,{value:a.type,onValueChange:n=>s(a.id,{type:n}),children:[e.jsx(q,{children:e.jsx(C,{})}),e.jsx(I,{children:fe.map(n=>e.jsx(_,{value:n.value,children:n.label},n.value))})]})]}),a.type!=="condition"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Next step"}),e.jsxs(S,{value:a.next||"",onValueChange:n=>s(a.id,{next:n||null}),children:[e.jsx(q,{children:e.jsx(C,{placeholder:"(end)"})}),e.jsxs(I,{children:[e.jsx(_,{value:"",children:"(end)"}),x.filter(n=>n!==a.id).map(n=>e.jsx(_,{value:n,children:n},n))]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Required action (optional)"}),e.jsxs(S,{value:String(((d=a.config)==null?void 0:d.required_action)||""),onValueChange:n=>s(a.id,{config:{...a.config,required_action:n||null}}),children:[e.jsx(q,{children:e.jsx(C,{placeholder:"(none)"})}),e.jsx(I,{children:Re.map(n=>e.jsx(_,{value:n.value,children:n.label},n.value))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"If set, the runner denies this step unless the triggering actor has the given permission."})]}),a.type==="condition"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Left"}),e.jsx(B,{value:String(((v=a.config)==null?void 0:v.left)||""),onChange:n=>s(a.id,{config:{...a.config,left:n.target.value}}),placeholder:"{{event_metadata.foo}}"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Op"}),e.jsxs(S,{value:String(((g=a.config)==null?void 0:g.op)||"eq"),onValueChange:n=>s(a.id,{config:{...a.config,op:n}}),children:[e.jsx(q,{children:e.jsx(C,{})}),e.jsx(I,{children:Fe.map(n=>e.jsx(_,{value:n.value,children:n.label},n.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"Right"}),e.jsx(B,{value:String(((p=a.config)==null?void 0:p.right)||""),onChange:n=>s(a.id,{config:{...a.config,right:n.target.value}}),placeholder:"some.value"})]})]}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"On true"}),e.jsxs(S,{value:a.on_true||"",onValueChange:n=>s(a.id,{on_true:n||null}),children:[e.jsx(q,{children:e.jsx(C,{placeholder:"(end)"})}),e.jsxs(I,{children:[e.jsx(_,{value:"",children:"(end)"}),x.filter(n=>n!==a.id).map(n=>e.jsx(_,{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium",children:"On false"}),e.jsxs(S,{value:a.on_false||"",onValueChange:n=>s(a.id,{on_false:n||null}),children:[e.jsx(q,{children:e.jsx(C,{placeholder:"(end)"})}),e.jsxs(I,{children:[e.jsx(_,{value:"",children:"(end)"}),x.filter(n=>n!==a.id).map(n=>e.jsx(_,{value:n,children:n},n))]})]})]})]})]}),a.type==="create_entity"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-medium",children:"Config (JSON)"}),e.jsx($,{value:JSON.stringify(a.config||{},null,2),onChange:n=>s(a.id,{config:Q(n.target.value)||{}}),rows:6}),e.jsx(je,{value:((V=a.config)==null?void 0:V.fields)||{},onChange:n=>s(a.id,{config:{...a.config,fields:n}}),placeholderKey:"field",placeholderValue:"value/template"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["For execution, set ",e.jsx("code",{children:"entity"})," and ",e.jsx("code",{children:"fields"}),". Example:"," ",e.jsx("code",{children:'{ "entity": "partner_submissions", "fields": { "status": "pending" } }'})]})]}),a.type==="update_entity"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-medium",children:"Config (JSON)"}),e.jsx($,{value:JSON.stringify(a.config||{},null,2),onChange:n=>s(a.id,{config:Q(n.target.value)||{}}),rows:6}),e.jsx(je,{value:((Y=a.config)==null?void 0:Y.patch)||{},onChange:n=>s(a.id,{config:{...a.config,patch:n}}),placeholderKey:"field",placeholderValue:"value/template"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["For execution, set ",e.jsx("code",{children:"entity"}),", ",e.jsx("code",{children:"id"}),", and ",e.jsx("code",{children:"patch"}),". Example:"," ",e.jsx("code",{children:'{ "entity": "partner_submissions", "id": "{{event_metadata.submission_id}}", "patch": { "status": "approved" } }'})]})]}),a.type==="notify"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-medium",children:"Config (JSON)"}),e.jsx($,{value:JSON.stringify(a.config||{},null,2),onChange:n=>s(a.id,{config:Q(n.target.value)||{}}),rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Notification currently records an analytics event (and can be extended to real in-app notifications)."})]}),a.type==="noop"&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"No-op step. Useful as an explicit branch target."})]})]},a.id)})})]})]}),e.jsxs(O,{children:[e.jsx(D,{children:e.jsx(T,{children:"Definition (preview)"})}),e.jsx(J,{children:e.jsx($,{value:JSON.stringify(l,null,2),readOnly:!0,rows:10})})]})]})}const z={type:"event",event_name:"messaging.message_sent"},U={version:2,steps:[]},Pe=[{value:"create_entity",label:"Create entity"},{value:"update_entity",label:"Update entity"},{value:"condition",label:"Condition (branch)"},{value:"notify",label:"Notify (in-app)"},{value:"noop",label:"No-op"}];function H(o,u){try{return JSON.parse(o)??u}catch{return u}}function He(){var ce;const{data:o}=Oe(),u=(o==null?void 0:o.districtId)??null,f=(o==null?void 0:o.schoolId)??null,l=(o==null?void 0:o.role)??null,{data:m,refetch:x}=F({queryKey:["workflow_definitions",u,f],enabled:!!o,queryFn:async()=>{const t=`query Workflows($districtId: uuid, $schoolId: uuid) {
        workflow_definitions(
          order_by: { updated_at: desc }
          where: {
            _and: [
              { _or: [ { district_id: { _is_null: true } }, { district_id: { _eq: $districtId } } ] }
              { _or: [ { school_id: { _is_null: true } }, { school_id: { _eq: $schoolId } } ] }
            ]
          }
        ) {
          id
          name
          status
          version
          pinned_version
          published_version
          review_requested_at
          approved_at
          published_at
          trigger
          definition
          created_by
          updated_at
        }
      }`,{data:r,error:i}=await k.request(t,{districtId:u,schoolId:f});if(i)throw i;return r.workflow_definitions}}),[c,y]=j.useState(null),s=j.useMemo(()=>(m==null?void 0:m.find(t=>t.id===c))??(m==null?void 0:m[0])??null,[m,c]),{data:h}=F({queryKey:["workflow_definition_versions",s==null?void 0:s.id],enabled:!!(s!=null&&s.id),queryFn:async()=>{const t=`query Versions($workflowId: uuid!) {
        workflow_definition_versions(
          where: { workflow_id: { _eq: $workflowId } }
          order_by: { version: desc }
        ) {
          id
          version
          created_at
          created_by
          trigger
          definition
        }
      }`,{data:r,error:i}=await k.request(t,{workflowId:s.id});if(i)throw i;return r.workflow_definition_versions}}),{data:a}=F({queryKey:["tenant_settings_min_approvals",u,f],enabled:!!o,queryFn:async()=>{const t=`query TenantSettings($districtId: uuid, $schoolId: uuid) {
        tenant_settings(
          where: {
            _or: [
              { school_id: { _eq: $schoolId } }
              { _and: [ { district_id: { _eq: $districtId } }, { school_id: { _is_null: true } } ] }
            ]
          }
          limit: 5
        ) {
          district_id
          school_id
          settings
        }
      }`,{data:r,error:i}=await k.request(t,{districtId:u,schoolId:f});if(i)throw i;return r.tenant_settings}}),d=j.useMemo(()=>{var P;const t=a??[],r=t.find(L=>f&&L.school_id===f)||t.find(L=>u&&L.district_id===u)||null,i=(r==null?void 0:r.settings)||{},N=Number(i==null?void 0:i.workflow_min_approvals);if(Number.isFinite(N)&&N>=1)return Math.min(5,Math.floor(N));const w=Number((P=i==null?void 0:i.workflow)==null?void 0:P.min_approvals);return Number.isFinite(w)&&w>=1?Math.min(5,Math.floor(w)):1},[a,u,f]),{data:v,refetch:g}=F({queryKey:["workflow_approvals",s==null?void 0:s.id,s==null?void 0:s.version],enabled:!!(s!=null&&s.id),queryFn:async()=>{const t=`query Approvals($workflowId: uuid!, $version: Int!) {
        workflow_approvals(
          where: { workflow_id: { _eq: $workflowId }, version: { _eq: $version } }
          order_by: { created_at: desc }
        ) {
          id
          approver_user_id
          reason
          created_at
        }
      }`,{data:r,error:i}=await k.request(t,{workflowId:s.id,version:s.version});if(i)throw i;return r.workflow_approvals}}),p=(v==null?void 0:v.length)??0,{data:V,refetch:Y}=F({queryKey:["workflow_dead_letters",s==null?void 0:s.id],enabled:!!(s!=null&&s.id),queryFn:async()=>{const t=`query DeadLetters($workflowId: uuid!) {
        workflow_dead_letters(
          where: { workflow_id: { _eq: $workflowId } }
          order_by: { created_at: desc }
          limit: 25
        ) {
          id
          run_id
          step_key
          error
          created_at
          metadata
        }
      }`,{data:r,error:i}=await k.request(t,{workflowId:s.id});if(i)throw i;return r.workflow_dead_letters}}),n=p>=d,ge=["admin","system_admin"].includes(String(l)),[X,Z]=j.useState(""),[ee,se]=j.useState(JSON.stringify(z,null,2)),[K,M]=j.useState(JSON.stringify(U,null,2)),[te,ae]=j.useState(""),[we,re]=j.useState("visual"),[E,le]=j.useState({open:!1,run:null,steps:[]});j.useMemo(()=>{s&&(Z(s.name??""),se(JSON.stringify(s.trigger??z,null,2)),M(JSON.stringify(s.definition??U,null,2)),ae(s.pinned_version!=null?String(s.pinned_version):""))},[s==null?void 0:s.id]);const{data:W,refetch:ne}=F({queryKey:["workflow_publication_audits",s==null?void 0:s.id],enabled:!!(s!=null&&s.id),queryFn:async()=>{const t=`query Audits($workflowId: uuid!) {
        workflow_publication_audits(
          where: { workflow_id: { _eq: $workflowId } }
          order_by: { created_at: desc }
          limit: 20
        ) {
          id
          action
          from_version
          to_version
          actor_user_id
          signature
          created_at
          metadata
        }
      }`,{data:r,error:i}=await k.request(t,{workflowId:s.id});if(i)throw i;return r.workflow_publication_audits}}),{data:G,refetch:_e}=F({queryKey:["workflow_runs",s==null?void 0:s.id],enabled:!!(s!=null&&s.id),queryFn:async()=>{const t=`query Runs($workflowId: uuid!) {
        workflow_runs(where: { workflow_id: { _eq: $workflowId } }, order_by: { started_at: desc }, limit: 25) {
          id
          status
          started_at
          finished_at
          input
          output
        }
      }`,{data:r,error:i}=await k.request(t,{workflowId:s.id});if(i)throw i;return r.workflow_runs}}),ye=async t=>{const r=`query RunSteps($runId: uuid!) {
      workflow_run_steps(where: { run_id: { _eq: $runId } }, order_by: { created_at: asc }) {
        id
        step_key
        status
        input
        output
        created_at
      }
    }`,{data:i,error:N}=await k.request(r,{runId:t.id});if(N)throw N;le({open:!0,run:t,steps:i.workflow_run_steps||[]})},Ne=async t=>{var N,w;if(!R(l,"automation:replay"))return;const r=(N=t==null?void 0:t.input)==null?void 0:N.event_name,i=((w=t==null?void 0:t.input)==null?void 0:w.event_metadata)||{};r&&(await A({eventName:r,metadata:{...i,replayed_from_run_id:t.id,replayed:!0}}),await _e())},be=async()=>{if(!(s!=null&&s.id))return;const{error:t}=await ie.functions.call("workflow-request-review",{workflowId:s.id});if(t)throw t;await A({eventName:"workflow.request_review",metadata:{workflow_id:s.id}}),await x(),await ne()},ke=async()=>{if(!(s!=null&&s.id))return;const{error:t}=await ie.functions.call("workflow-approve",{workflowId:s.id});if(t)throw t;await A({eventName:"workflow.approved",metadata:{workflow_id:s.id}}),await x(),await ne(),await g()},Se=async()=>{if(!(s!=null&&s.id))return;const{error:t}=await ie.functions.call("workflow-publish",{workflowId:s.id});if(t)throw t;await A({eventName:"workflow.published",metadata:{workflow_id:s.id}}),await x(),await ne()},oe=xe({mutationFn:async()=>{const t=H(ee,z),r=H(K,U),i=te?Number(te):null;if(s!=null&&s.id){const L=`mutation UpdateWorkflow($id: uuid!, $patch: workflow_definitions_set_input!) {
          update_workflow_definitions_by_pk(pk_columns: { id: $id }, _set: $patch) { id }
        }`,ue=["published","approved","in_review"].includes(String((s==null?void 0:s.status)??"")),$e={name:X,trigger:t,definition:r,pinned_version:i,status:ue?"draft":s.status,...ue?{review_requested_at:null,review_requested_by:null,approved_at:null,approved_by:null,published_at:null,published_by:null,published_version:null}:{}},{error:me}=await k.request(L,{id:s.id,patch:$e});if(me)throw me;return await A({eventName:"workflow.updated",metadata:{workflow_id:s.id}}),s.id}const N=`mutation InsertWorkflow($object: workflow_definitions_insert_input!) {
        insert_workflow_definitions_one(object: $object) { id }
      }`,{data:w,error:P}=await k.request(N,{object:{name:X||"Untitled workflow",status:"draft",trigger:t,definition:r,district_id:u,school_id:f,version:1,pinned_version:i}});if(P)throw P;return await A({eventName:"workflow.created",metadata:{workflow_id:w.insert_workflow_definitions_one.id}}),w.insert_workflow_definitions_one.id},onSuccess:async t=>{await x(),y(t)}}),de=xe({mutationFn:async t=>{if(!(s!=null&&s.id))return;const r=`mutation Rollback($id: uuid!, $patch: workflow_definitions_set_input!) {
        update_workflow_definitions_by_pk(pk_columns: { id: $id }, _set: $patch) { id version }
      }`,{error:i}=await k.request(r,{id:s.id,patch:{trigger:t.trigger,definition:t.definition}});if(i)throw i;await A({eventName:"workflow.rolled_back",metadata:{workflow_id:s.id,restored_version:t.version}})},onSuccess:async()=>{await x()}}),qe=()=>{y(null),Z(""),se(JSON.stringify(z,null,2)),M(JSON.stringify(U,null,2)),ae(""),re("visual")},Ce=t=>{const r=H(K,U),i=Array.isArray(r.steps)?r.steps:[],w={id:`step_${i.length+1}`,type:t,config:{}};t==="condition"&&(w.config={left:"{{event_name}}",op:"eq",right:"some.event"},w.on_true=null,w.on_false=null),i.push(w),M(JSON.stringify({...r,steps:i},null,2))},Ie=async()=>{const t=H(ee,z),r=(t==null?void 0:t.event_name)||"custom.event";await A({eventName:r,metadata:{simulated:!0,workflow_editor:!0}})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Workflows"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Event-triggered automation. This build supports real entity ops, branching, version pinning, and replay."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{variant:"outline",onClick:qe,children:"New"}),e.jsx(b,{onClick:()=>oe.mutate(),disabled:oe.isPending||!R(l,"automation:manage"),children:"Save"}),e.jsx(b,{variant:"secondary",onClick:Ie,disabled:!R(l,"automation:manage"),children:"Simulate trigger"})]})]}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-4",children:[e.jsxs(O,{children:[e.jsx(D,{children:e.jsx(T,{children:"Definitions"})}),e.jsx(J,{children:e.jsxs("div",{className:"space-y-2",children:[(m??[]).map(t=>e.jsxs("button",{className:`w-full rounded-md border px-3 py-2 text-left text-sm ${(s==null?void 0:s.id)===t.id?"bg-muted":"hover:bg-muted/50"}`,onClick:()=>y(t.id),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["v",t.version]})]}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:t.status})]},t.id)),!(m!=null&&m.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No workflows yet."})]})})]}),e.jsxs(O,{className:"lg:col-span-2",children:[e.jsx(D,{children:e.jsx(T,{children:"Editor"})}),e.jsxs(J,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Name"}),e.jsx(B,{value:X,onChange:t=>Z(t.target.value),placeholder:"e.g., Auto-create follow-up task"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Lifecycle"}),e.jsxs("div",{className:"rounded-md border px-3 py-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"text-sm font-medium capitalize",children:String((s==null?void 0:s.status)??"draft")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s!=null&&s.published_version?`published v${s.published_version}`:`current v${(s==null?void 0:s.version)??1}`})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(b,{variant:"outline",size:"sm",onClick:be,disabled:!(s!=null&&s.id)||!R(l,"automation:request_review")||String(s==null?void 0:s.status)!=="draft",children:"Request review"}),e.jsxs(b,{variant:"outline",size:"sm",onClick:ke,disabled:!(s!=null&&s.id)||!R(l,"automation:approve")||!["in_review","approved"].includes(String(s==null?void 0:s.status)),children:["Approve (",p,"/",d,")"]}),e.jsx(b,{size:"sm",onClick:Se,disabled:!(s!=null&&s.id)||!R(l,"automation:publish")||!ge&&(String(s==null?void 0:s.status)!=="approved"||!n),children:"Publish"})]}),e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Only ",e.jsx("span",{className:"font-medium",children:"published"})," workflows execute. Editing a published/in-review workflow moves it back to ",e.jsx("span",{className:"font-medium",children:"draft"})," on save."]})]})]})]}),e.jsxs("div",{className:"mt-4 grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Pinned version"}),e.jsxs(S,{value:te,onValueChange:ae,children:[e.jsx(q,{children:e.jsx(C,{placeholder:"Use latest"})}),e.jsxs(I,{children:[e.jsx(_,{value:"",children:"Use latest"}),(h??[]).map(t=>e.jsxs(_,{value:String(t.version),children:["Pin v",t.version]},t.id))]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pinning runs the selected historical snapshot (useful for safe rollouts)."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Trigger (JSON)"}),e.jsx($,{value:ee,onChange:t=>se(t.target.value),rows:6})]})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(De,{value:we,onValueChange:re,children:[e.jsxs(Te,{children:[e.jsx(he,{value:"visual",children:"Visual"}),e.jsx(he,{value:"json",children:"JSON"})]}),e.jsx(pe,{value:"visual",className:"mt-4",children:e.jsx(Me,{definitionJson:K,onChangeDefinitionJson:M})}),e.jsx(pe,{value:"json",className:"mt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium",children:"Definition (JSON)"}),e.jsxs(S,{onValueChange:Ce,children:[e.jsx(q,{className:"w-[200px]",children:e.jsx(C,{placeholder:"Quick add"})}),e.jsx(I,{children:Pe.map(t=>e.jsx(_,{value:t.value,children:t.label},t.value))})]})]}),e.jsx($,{value:K,onChange:t=>M(t.target.value),rows:14}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["v2 supports condition steps with ",e.jsx("code",{children:"on_true"}),"/",e.jsx("code",{children:"on_false"})," edges. Templates like"," ",e.jsx("code",{children:"{{event_metadata.thread_id}}"})," are resolved at runtime."]})]})})]})})]})]}),e.jsxs(O,{children:[e.jsx(D,{children:e.jsx(T,{children:"Versions"})}),e.jsxs(J,{children:[!(s!=null&&s.id)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a workflow."}),(s==null?void 0:s.id)&&!(h!=null&&h.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No versions yet."}),e.jsx("div",{className:"space-y-2",children:(h??[]).slice(0,10).map(t=>e.jsxs("div",{className:"rounded-md border p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"font-medium",children:["v",t.version]}),e.jsx(b,{size:"sm",variant:"outline",onClick:()=>de.mutate(t),disabled:de.isPending||!(s!=null&&s.id),children:"Restore"})]}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:t.created_at?new Date(t.created_at).toLocaleString():""})]},t.id))}),e.jsx("p",{className:"mt-4 text-xs text-muted-foreground",children:"Restoring a version updates the live definition and auto-creates a new snapshot (audit-friendly)."})]})]}),e.jsxs(O,{children:[e.jsx(D,{children:e.jsx(T,{children:"Publication audit"})}),e.jsxs(J,{children:[!(s!=null&&s.id)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a workflow."}),(s==null?void 0:s.id)&&!(W!=null&&W.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No audit events yet."}),e.jsx("div",{className:"space-y-2",children:(W??[]).map(t=>e.jsxs("div",{className:"rounded-md border p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"font-medium capitalize",children:String(t.action).replaceAll("_"," ")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.created_at?new Date(t.created_at).toLocaleString():""})]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["v",t.from_version??"?"," → v",t.to_version??"?"]}),t.signature&&e.jsxs("div",{className:"mt-2 break-all text-xs text-muted-foreground",children:["sig: ",String(t.signature).slice(0,24),"…"]})]},t.id))})]})]}),e.jsxs(O,{className:"lg:col-span-4",children:[e.jsx(D,{children:e.jsx(T,{children:"Dead letters"})}),e.jsxs(J,{children:[!(s!=null&&s.id)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a workflow to see dead letters."}),(s==null?void 0:s.id)&&!(V!=null&&V.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No dead letters."}),e.jsx("div",{className:"space-y-2",children:(V??[]).map(t=>e.jsxs("div",{className:"rounded-md border p-3 text-sm",children:[e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.step_key}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[t.created_at?new Date(t.created_at).toLocaleString():"",t.run_id?` • run ${t.run_id}`:""]})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.metadata&&t.metadata.attempts?`attempts: ${t.metadata.attempts}`:""})]}),t.error&&e.jsx("div",{className:"mt-2 text-xs",children:t.error})]},t.id))})]})]}),e.jsxs(O,{className:"lg:col-span-4",children:[e.jsx(D,{children:e.jsx(T,{children:"Recent runs"})}),e.jsxs(J,{children:[!(s!=null&&s.id)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a workflow to see runs."}),(s==null?void 0:s.id)&&!(G!=null&&G.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No runs yet."}),e.jsx("div",{className:"space-y-2",children:(G??[]).map(t=>e.jsx("div",{className:"rounded-md border p-3 text-sm",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.status}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[t.started_at?new Date(t.started_at).toLocaleString():"",t.finished_at?` → ${new Date(t.finished_at).toLocaleString()}`:""]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",variant:"outline",onClick:()=>ye(t),children:"View"}),e.jsx(b,{size:"sm",variant:"secondary",onClick:()=>Ne(t),disabled:!R(l,"automation:replay"),children:"Replay"})]})]})},t.id))})]})]})]}),e.jsx(Je,{open:E.open,onOpenChange:t=>le(r=>({...r,open:t})),children:e.jsxs(Ee,{className:"max-w-3xl",children:[e.jsx(Ae,{children:e.jsx(Ve,{children:"Workflow run"})}),e.jsxs("div",{className:"space-y-4",children:[E.run&&e.jsxs("div",{className:"rounded-md border p-3 text-sm",children:[e.jsx("div",{className:"font-medium",children:E.run.id}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Status: ",E.run.status]}),e.jsxs("div",{className:"mt-2 grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium mb-1",children:"Input"}),e.jsx($,{value:JSON.stringify(E.run.input||{},null,2),readOnly:!0,rows:10})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium mb-1",children:"Output"}),e.jsx($,{value:JSON.stringify(E.run.output||{},null,2),readOnly:!0,rows:10})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Steps"}),!((ce=E.steps)!=null&&ce.length)&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"No step rows."}),e.jsx("div",{className:"space-y-2",children:(E.steps||[]).map(t=>e.jsxs("div",{className:"rounded-md border p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium",children:t.step_key}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.status})]}),e.jsxs("div",{className:"mt-2 grid gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium mb-1",children:"Input"}),e.jsx($,{value:JSON.stringify(t.input||{},null,2),readOnly:!0,rows:6})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium mb-1",children:"Output"}),e.jsx($,{value:JSON.stringify(t.output||{},null,2),readOnly:!0,rows:6})]})]})]},t.id))})]})]})]})})]})}export{He as default};
//# sourceMappingURL=AdminWorkflows-CSHERGtU.js.map
