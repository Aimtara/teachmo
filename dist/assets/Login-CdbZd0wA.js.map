{"version":3,"file":"Login-CdbZd0wA.js","sources":["../../src/hooks/useTenantSSOSettings.ts","../../src/pages/Login.jsx"],"sourcesContent":["import { useQuery } from '@tanstack/react-query';\nimport { graphqlRequest } from '@/lib/graphql';\nimport { useTenantScope } from '@/hooks/useTenantScope';\n\n/**\n * useTenantSSOSettings fetches the enabled SSO providers and the requireSso flag\n * for the current tenant (organization).  It reads enterprise_sso_settings rows\n * scoped to the tenant where is_enabled = true and looks for a require_sso flag\n * stored inside tenant_settings.settings.  The hook returns { providers, requireSso }.\n */\nexport function useTenantSSOSettings() {\n  const { data: scope } = useTenantScope();\n  const organizationId = scope?.organizationId ?? scope?.districtId ?? null;\n\n  return useQuery({\n    queryKey: ['tenant-sso-settings', organizationId],\n    enabled: Boolean(organizationId),\n    queryFn: async () => {\n      const query = /* GraphQL */ `\n        query TenantSSOSettings($organizationId: uuid!) {\n          enterprise_sso_settings(where: { organization_id: { _eq: $organizationId }, is_enabled: { _eq: true } }) {\n            provider\n          }\n          tenant_settings(where: { district_id: { _eq: $organizationId }, school_id: { _is_null: true } }, limit: 1) {\n            settings\n          }\n        }\n      `;\n      const res = await graphqlRequest(query, { organizationId });\n      // Build list of enabled provider IDs\n      const providers: string[] =\n        res?.enterprise_sso_settings?.map((row: any) => row.provider).filter(Boolean) ?? [];\n      // Extract require_sso flag from settings JSON\n      let requireSso = false;\n      const settings =\n        res?.tenant_settings?.[0]?.settings ??\n        {};\n      if (settings) {\n        // Accept camelCase or snake_case flags\n        if (typeof settings.require_sso === 'boolean') {\n          requireSso = settings.require_sso;\n        } else if (typeof settings.requireSso === 'boolean') {\n          requireSso = settings.requireSso;\n        }\n      }\n      return { providers, requireSso };\n    },\n  });\n}\n\nexport default useTenantSSOSettings;\n","import { useState, useEffect } from 'react';\nimport { nhost } from '@/lib/nhostClient';\nimport { SocialLoginButtons } from '@/components/auth/SocialLoginButtons';\nimport useTenantSSOSettings from '@/hooks/useTenantSSOSettings';\nimport { createLogger } from '@/utils/logger';\n\nconst logger = createLogger('login');\n\nexport default function Login() {\n  const [email, setEmail] = useState('');\n  const [password, setPassword] = useState('');\n  const [error, setError] = useState(null);\n  const [redirecting, setRedirecting] = useState(false);\n\n  // Fetch tenant SSO settings (enabled providers and requireSso flag)\n  const { data: ssoSettings } = useTenantSSOSettings();\n  const requireSso = ssoSettings?.requireSso || false;\n  const enabledProviders = ssoSettings?.providers || [];\n\n  const handleEmailLogin = async (event) => {\n    event.preventDefault();\n    setError(null);\n    try {\n      await nhost.auth.signIn({\n        email,\n        password,\n      });\n    } catch (err) {\n      logger.error('Email login failed', err);\n      setError(err?.message || 'Login failed');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8\">\n      <div className=\"max-w-md w-full space-y-8\">\n        <div className=\"text-center space-y-2\">\n          <h1 className=\"text-2xl font-semibold text-gray-900\">Sign in to Teachmo</h1>\n          <p className=\"text-sm text-gray-600\">Use your school account to continue</p>\n        </div>\n        {error && (\n          <p role=\"alert\" className=\"text-red-600 text-sm text-center\">\n            {error}\n          </p>\n        )}\n        {/* Automatically redirect to the only enabled SSO provider when required */}\n        {requireSso && enabledProviders.length === 1 && (\n          <AutoSSORedirect\n            provider={enabledProviders[0]}\n            onError={(err) => setError(err?.message || 'Login failed')}\n            onStart={() => setRedirecting(true)}\n          />\n        )}\n        {/* If multiple providers or SSO optional, show provider buttons */}\n        {(!requireSso || enabledProviders.length !== 1) && (\n          <SocialLoginButtons\n            onError={(err) => setError(err?.message || 'Login failed')}\n            providers={enabledProviders.length ? enabledProviders : null}\n          />\n        )}\n        {/* Show redirect message when auto-redirecting */}\n        {redirecting && (\n          <p className=\"text-center text-sm text-gray-500\">Redirecting to your single sign-on providerâ€¦</p>\n        )}\n        <div className=\"relative\">\n          <div className=\"absolute inset-0 flex items-center\" aria-hidden=\"true\">\n            <div className=\"w-full border-t border-gray-200\" />\n          </div>\n          <div className=\"relative flex justify-center text-sm\">\n            <span className=\"bg-gray-50 px-2 text-gray-500\">or</span>\n          </div>\n        </div>\n        {!requireSso && (\n          <form className=\"mt-8 space-y-4\" onSubmit={handleEmailLogin}>\n            <div>\n              <label htmlFor=\"email\" className=\"sr-only\">\n                Email address\n              </label>\n              <input\n                id=\"email\"\n                name=\"email\"\n                type=\"email\"\n                required\n                placeholder=\"Email address\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                className=\"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500\"\n              />\n            </div>\n            <div>\n              <label htmlFor=\"password\" className=\"sr-only\">\n                Password\n              </label>\n              <input\n                id=\"password\"\n                name=\"password\"\n                type=\"password\"\n                required\n                placeholder=\"Password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500\"\n              />\n            </div>\n            <button\n              type=\"submit\"\n              className=\"w-full flex justify-center rounded-md bg-emerald-600 py-2 px-4 text-sm font-semibold text-white hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500\"\n            >\n              Sign in\n            </button>\n          </form>\n        )}\n      </div>\n    </div>\n  );\n}\n\n/**\n * AutoSSORedirect triggers an immediate signIn with the given provider when mounted.\n * It calls onStart before initiating the redirect and onError if the call fails.\n */\nfunction AutoSSORedirect({ provider, onStart, onError }) {\n  useEffect(() => {\n    async function go() {\n      try {\n        onStart?.();\n        await nhost.auth.signIn({\n          provider,\n          options: {\n            redirectTo: `${window.location.origin}/auth/callback`,\n          },\n        });\n      } catch (err) {\n        logger.error('SSO redirect failed', err);\n        onError?.(err);\n      }\n    }\n    if (provider) {\n      go();\n    }\n  }, [onError, onStart, provider]);\n  return null;\n}\n"],"names":["useTenantSSOSettings","scope","useTenantScope","organizationId","useQuery","res","graphqlRequest","providers","_a","row","requireSso","settings","_c","_b","logger","createLogger","Login","email","setEmail","useState","password","setPassword","error","setError","redirecting","setRedirecting","ssoSettings","enabledProviders","handleEmailLogin","event","nhost","err","jsxs","jsx","AutoSSORedirect","SocialLoginButtons","e","provider","onStart","onError","useEffect","go"],"mappings":"yFAUO,SAASA,GAAuB,CACrC,KAAM,CAAE,KAAMC,CAAA,EAAUC,EAAA,EAClBC,GAAiBF,GAAA,YAAAA,EAAO,kBAAkBA,GAAA,YAAAA,EAAO,aAAc,KAErE,OAAOG,EAAS,CACd,SAAU,CAAC,sBAAuBD,CAAc,EAChD,QAAS,EAAQA,EACjB,QAAS,SAAY,WAWnB,MAAME,EAAM,MAAMC,EAVU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAU8B,EAEpDC,IACJC,EAAAH,GAAA,YAAAA,EAAK,0BAAL,YAAAG,EAA8B,IAAKC,GAAaA,EAAI,UAAU,OAAO,WAAY,CAAA,EAEnF,IAAIC,EAAa,GACjB,MAAMC,IACJC,GAAAC,EAAAR,GAAA,YAAAA,EAAK,kBAAL,YAAAQ,EAAuB,KAAvB,YAAAD,EAA2B,WAC3B,CAAA,EACF,OAAID,IAEE,OAAOA,EAAS,aAAgB,UAClCD,EAAaC,EAAS,YACb,OAAOA,EAAS,YAAe,YACxCD,EAAaC,EAAS,aAGnB,CAAE,UAAAJ,EAAW,WAAAG,CAAA,CACtB,CAAA,CACD,CACH,CC1CA,MAAMI,EAASC,EAAa,OAAO,EAEnC,SAAwBC,GAAQ,CAC9B,KAAM,CAACC,EAAOC,CAAQ,EAAIC,EAAAA,SAAS,EAAE,EAC/B,CAACC,EAAUC,CAAW,EAAIF,EAAAA,SAAS,EAAE,EACrC,CAACG,EAAOC,CAAQ,EAAIJ,EAAAA,SAAS,IAAI,EACjC,CAACK,EAAaC,CAAc,EAAIN,EAAAA,SAAS,EAAK,EAG9C,CAAE,KAAMO,CAAA,EAAgB1B,EAAA,EACxBU,GAAagB,GAAA,YAAAA,EAAa,aAAc,GACxCC,GAAmBD,GAAA,YAAAA,EAAa,YAAa,CAAA,EAE7CE,EAAmB,MAAOC,GAAU,CACxCA,EAAM,eAAA,EACNN,EAAS,IAAI,EACb,GAAI,CACF,MAAMO,EAAM,KAAK,OAAO,CACtB,MAAAb,EACA,SAAAG,CAAA,CACD,CACH,OAASW,EAAK,CACZjB,EAAO,MAAM,qBAAsBiB,CAAG,EACtCR,GAASQ,GAAA,YAAAA,EAAK,UAAW,cAAc,CACzC,CACF,EAEA,aACG,MAAA,CAAI,UAAU,sFACb,SAAAC,EAAAA,KAAC,MAAA,CAAI,UAAU,4BACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,wBACb,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,uCAAuC,SAAA,qBAAkB,EACvEA,EAAAA,IAAC,IAAA,CAAE,UAAU,wBAAwB,SAAA,qCAAA,CAAmC,CAAA,EAC1E,EACCX,GACCW,EAAAA,IAAC,IAAA,CAAE,KAAK,QAAQ,UAAU,mCACvB,SAAAX,EACH,EAGDZ,GAAciB,EAAiB,SAAW,GACzCM,EAAAA,IAACC,EAAA,CACC,SAAUP,EAAiB,CAAC,EAC5B,QAAUI,GAAQR,GAASQ,GAAA,YAAAA,EAAK,UAAW,cAAc,EACzD,QAAS,IAAMN,EAAe,EAAI,CAAA,CAAA,GAIpC,CAACf,GAAciB,EAAiB,SAAW,IAC3CM,EAAAA,IAACE,EAAA,CACC,QAAUJ,GAAQR,GAASQ,GAAA,YAAAA,EAAK,UAAW,cAAc,EACzD,UAAWJ,EAAiB,OAASA,EAAmB,IAAA,CAAA,EAI3DH,GACCS,EAAAA,IAAC,IAAA,CAAE,UAAU,oCAAoC,SAAA,+CAA4C,EAE/FD,EAAAA,KAAC,MAAA,CAAI,UAAU,WACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,qCAAqC,cAAY,OAC9D,SAAAA,EAAAA,IAAC,MAAA,CAAI,UAAU,iCAAA,CAAkC,CAAA,CACnD,EACAA,EAAAA,IAAC,OAAI,UAAU,uCACb,eAAC,OAAA,CAAK,UAAU,gCAAgC,SAAA,IAAA,CAAE,CAAA,CACpD,CAAA,EACF,EACC,CAACvB,GACAsB,EAAAA,KAAC,QAAK,UAAU,iBAAiB,SAAUJ,EACzC,SAAA,CAAAI,OAAC,MAAA,CACC,SAAA,CAAAC,MAAC,QAAA,CAAM,QAAQ,QAAQ,UAAU,UAAU,SAAA,gBAE3C,EACAA,EAAAA,IAAC,QAAA,CACC,GAAG,QACH,KAAK,QACL,KAAK,QACL,SAAQ,GACR,YAAY,gBACZ,MAAOhB,EACP,SAAWmB,GAAMlB,EAASkB,EAAE,OAAO,KAAK,EACxC,UAAU,0JAAA,CAAA,CACZ,EACF,SACC,MAAA,CACC,SAAA,CAAAH,MAAC,QAAA,CAAM,QAAQ,WAAW,UAAU,UAAU,SAAA,WAE9C,EACAA,EAAAA,IAAC,QAAA,CACC,GAAG,WACH,KAAK,WACL,KAAK,WACL,SAAQ,GACR,YAAY,WACZ,MAAOb,EACP,SAAWgB,GAAMf,EAAYe,EAAE,OAAO,KAAK,EAC3C,UAAU,0JAAA,CAAA,CACZ,EACF,EACAH,EAAAA,IAAC,SAAA,CACC,KAAK,SACL,UAAU,8LACX,SAAA,SAAA,CAAA,CAED,CAAA,CACF,CAAA,CAAA,CAEJ,CAAA,CACF,CAEJ,CAMA,SAASC,EAAgB,CAAE,SAAAG,EAAU,QAAAC,EAAS,QAAAC,GAAW,CACvDC,OAAAA,EAAAA,UAAU,IAAM,CACd,eAAeC,GAAK,CAClB,GAAI,CACFH,GAAA,MAAAA,IACA,MAAMR,EAAM,KAAK,OAAO,CACtB,SAAAO,EACA,QAAS,CACP,WAAY,GAAG,OAAO,SAAS,MAAM,gBAAA,CACvC,CACD,CACH,OAASN,EAAK,CACZjB,EAAO,MAAM,sBAAuBiB,CAAG,EACvCQ,GAAA,MAAAA,EAAUR,EACZ,CACF,CACIM,GACFI,EAAA,CAEJ,EAAG,CAACF,EAASD,EAASD,CAAQ,CAAC,EACxB,IACT"}