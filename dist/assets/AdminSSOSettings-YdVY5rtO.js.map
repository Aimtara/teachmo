{"version":3,"file":"AdminSSOSettings-YdVY5rtO.js","sources":["../../src/pages/AdminSSOSettings.jsx"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { graphql } from '@/lib/graphql';\nimport { useTenantScope } from '@/hooks/useTenantScope';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\n\nconst PROVIDERS = [\n  { id: 'google', label: 'Google Workspace' },\n  { id: 'azuread', label: 'Azure AD' },\n  { id: 'clever', label: 'Clever' },\n  { id: 'classlink', label: 'ClassLink' },\n  { id: 'okta', label: 'Okta' },\n  { id: 'saml', label: 'SAML' }\n];\n\nfunction safeJsonParse(value) {\n  try {\n    return value ? JSON.parse(value) : {};\n  } catch {\n    return {};\n  }\n}\n\nexport default function AdminSSOSettings() {\n  const { data: scope } = useTenantScope();\n  const organizationId = scope?.organizationId ?? null;\n\n  const domainsQuery = useQuery({\n    queryKey: ['tenant-domains', organizationId],\n    enabled: Boolean(organizationId),\n    queryFn: async () => {\n      const query = `query TenantDomains($organizationId: uuid!) {\n        tenant_domains(where: { organization_id: { _eq: $organizationId } }, order_by: { domain: asc }) {\n          id\n          domain\n          is_primary\n          verified_at\n        }\n      }`;\n      const res = await graphql(query, { organizationId });\n      return res?.tenant_domains ?? [];\n    }\n  });\n\n  const ssoQuery = useQuery({\n    queryKey: ['enterprise-sso-settings', organizationId],\n    enabled: Boolean(organizationId),\n    queryFn: async () => {\n      const query = `query EnterpriseSsoSettings($organizationId: uuid!) {\n        enterprise_sso_settings(where: { organization_id: { _eq: $organizationId } }, order_by: { provider: asc }) {\n          id\n          provider\n          client_id\n          client_secret\n          issuer\n          metadata\n          is_enabled\n        }\n      }`;\n      const res = await graphql(query, { organizationId });\n      return res?.enterprise_sso_settings ?? [];\n    }\n  });\n\n  const [newDomain, setNewDomain] = useState('');\n  const [providerState, setProviderState] = useState({});\n\n  useEffect(() => {\n    const initial = {};\n    PROVIDERS.forEach((provider) => {\n      const existing = ssoQuery.data?.find((row) => row.provider === provider.id);\n      initial[provider.id] = {\n        id: existing?.id ?? null,\n        provider: provider.id,\n        client_id: existing?.client_id ?? '',\n        client_secret: existing?.client_secret ?? '',\n        issuer: existing?.issuer ?? '',\n        metadata: JSON.stringify(existing?.metadata ?? {}, null, 2),\n        is_enabled: Boolean(existing?.is_enabled)\n      };\n    });\n    setProviderState(initial);\n  }, [ssoQuery.data]);\n\n  const updateProvider = (providerId, changes) => {\n    setProviderState((prev) => ({\n      ...prev,\n      [providerId]: {\n        ...prev[providerId],\n        ...changes\n      }\n    }));\n  };\n\n  const addDomainMutation = useMutation({\n    mutationFn: async () => {\n      if (!organizationId) throw new Error('Missing organization scope');\n      const mutation = `mutation InsertDomain($object: tenant_domains_insert_input!) {\n        insert_tenant_domains_one(object: $object) { id }\n      }`;\n      await graphql(mutation, {\n        object: {\n          organization_id: organizationId,\n          domain: newDomain.trim().toLowerCase(),\n          is_primary: false\n        }\n      });\n    },\n    onSuccess: () => {\n      setNewDomain('');\n      domainsQuery.refetch();\n    }\n  });\n\n  const setPrimaryMutation = useMutation({\n    mutationFn: async ({ id }) => {\n      const mutation = `mutation SetPrimary($organizationId: uuid!, $id: uuid!) {\n        update_tenant_domains(where: { organization_id: { _eq: $organizationId } }, _set: { is_primary: false }) {\n          affected_rows\n        }\n        update_tenant_domains_by_pk(pk_columns: { id: $id }, _set: { is_primary: true }) { id }\n      }`;\n      await graphql(mutation, { organizationId, id });\n    },\n    onSuccess: () => domainsQuery.refetch()\n  });\n\n  const removeDomainMutation = useMutation({\n    mutationFn: async ({ id }) => {\n      const mutation = `mutation DeleteDomain($id: uuid!) {\n        delete_tenant_domains_by_pk(id: $id) { id }\n      }`;\n      await graphql(mutation, { id });\n    },\n    onSuccess: () => domainsQuery.refetch()\n  });\n\n  const saveProviderMutation = useMutation({\n    mutationFn: async ({ providerId }) => {\n      if (!organizationId) throw new Error('Missing organization scope');\n      const config = providerState[providerId];\n      const mutation = `mutation UpsertSso($object: enterprise_sso_settings_insert_input!) {\n        insert_enterprise_sso_settings_one(\n          object: $object,\n          on_conflict: {\n            constraint: enterprise_sso_settings_organization_id_provider_key,\n            update_columns: [client_id, client_secret, issuer, metadata, is_enabled]\n          }\n        ) { id }\n      }`;\n      await graphql(mutation, {\n        object: {\n          organization_id: organizationId,\n          provider: providerId,\n          client_id: config.client_id || null,\n          client_secret: config.client_secret || null,\n          issuer: config.issuer || null,\n          metadata: safeJsonParse(config.metadata),\n          is_enabled: Boolean(config.is_enabled)\n        }\n      });\n    },\n    onSuccess: () => ssoQuery.refetch()\n  });\n\n  const domainRows = useMemo(() => domainsQuery.data ?? [], [domainsQuery.data]);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\">SSO Policy</h1>\n        <p className=\"text-sm text-muted-foreground\">\n          Manage tenant domains and configure enterprise SSO providers for your organization.\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Tenant Domains</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex flex-col gap-3 md:flex-row md:items-center\">\n            <Input\n              value={newDomain}\n              onChange={(event) => setNewDomain(event.target.value)}\n              placeholder=\"district.edu\"\n              className=\"md:max-w-sm\"\n            />\n            <Button\n              onClick={() => addDomainMutation.mutate()}\n              disabled={!newDomain.trim() || addDomainMutation.isLoading || !organizationId}\n            >\n              Add domain\n            </Button>\n          </div>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Domain</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead>Primary</TableHead>\n                <TableHead></TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {domainRows.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={4} className=\"text-sm text-muted-foreground\">\n                    No tenant domains configured yet.\n                  </TableCell>\n                </TableRow>\n              ) : (\n                domainRows.map((domain) => (\n                  <TableRow key={domain.id}>\n                    <TableCell className=\"font-mono text-xs\">{domain.domain}</TableCell>\n                    <TableCell>{domain.verified_at ? 'Verified' : 'Pending'}</TableCell>\n                    <TableCell>\n                      <Checkbox\n                        checked={domain.is_primary}\n                        onCheckedChange={() => setPrimaryMutation.mutate({ id: domain.id })}\n                        aria-label={`Set ${domain.domain} primary`}\n                      />\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => removeDomainMutation.mutate({ id: domain.id })}\n                      >\n                        Remove\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>SSO Providers</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {PROVIDERS.map((provider) => {\n            const config = providerState[provider.id] ?? {};\n            return (\n              <div key={provider.id} className=\"rounded-lg border p-4 space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <div className=\"text-sm font-semibold\">{provider.label}</div>\n                    <div className=\"text-xs text-muted-foreground\">Provider key: {provider.id}</div>\n                  </div>\n                  <Checkbox\n                    checked={Boolean(config.is_enabled)}\n                    onCheckedChange={(checked) => updateProvider(provider.id, { is_enabled: checked })}\n                    aria-label={`Enable ${provider.label}`}\n                  />\n                </div>\n                <div className=\"grid gap-3 md:grid-cols-2\">\n                  <Input\n                    value={config.client_id ?? ''}\n                    onChange={(event) => updateProvider(provider.id, { client_id: event.target.value })}\n                    placeholder=\"Client ID\"\n                  />\n                  <Input\n                    value={config.client_secret ?? ''}\n                    onChange={(event) => updateProvider(provider.id, { client_secret: event.target.value })}\n                    placeholder=\"Client Secret\"\n                    type=\"password\"\n                  />\n                  <Input\n                    value={config.issuer ?? ''}\n                    onChange={(event) => updateProvider(provider.id, { issuer: event.target.value })}\n                    placeholder=\"Issuer / Metadata URL\"\n                  />\n                </div>\n                <Textarea\n                  value={config.metadata ?? ''}\n                  onChange={(event) => updateProvider(provider.id, { metadata: event.target.value })}\n                  rows={4}\n                  placeholder='{\"scopes\": [\"openid\", \"profile\"]}'\n                />\n                <div className=\"flex justify-end\">\n                  <Button\n                    onClick={() => saveProviderMutation.mutate({ providerId: provider.id })}\n                    disabled={saveProviderMutation.isLoading || !organizationId}\n                  >\n                    {saveProviderMutation.isLoading ? 'Savingâ€¦' : 'Save provider'}\n                  </Button>\n                </div>\n              </div>\n            );\n          })}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":["PROVIDERS","safeJsonParse","value","AdminSSOSettings","scope","useTenantScope","organizationId","domainsQuery","useQuery","res","graphql","ssoQuery","newDomain","setNewDomain","useState","providerState","setProviderState","useEffect","initial","provider","existing","_a","row","updateProvider","providerId","changes","prev","addDomainMutation","useMutation","setPrimaryMutation","id","removeDomainMutation","saveProviderMutation","config","domainRows","useMemo","jsxs","jsx","Card","CardHeader","CardTitle","CardContent","Input","event","Button","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","domain","Checkbox","checked","Textarea"],"mappings":"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"}