import{b as O,D as V,h as H,M as G,r as l,w as J,j as e,C as R,i as D,k as F,o as P,B as b,F as A,n as K}from"./index-CXW08ga6.js";import{u as E}from"./useMutation-mXVxaFfD.js";import{I as v}from"./input-DQ0nv64R.js";import{S as B,a as q,b as L,c as M,d as I}from"./select-CevpuT8Q.js";const z=["parent","teacher","school_admin","district_admin","system_admin"],Y=`
query ListUserProfiles($where: user_profiles_bool_exp, $limit: Int!, $offset: Int!) {
  user_profiles(where: $where, limit: $limit, offset: $offset, order_by: { created_at: desc }) {
    user_id
    role
    district_id
    school_id
    full_name
    created_at
  }
  user_profiles_aggregate(where: $where) { aggregate { count } }
}
`,W=`
mutation UpdateUserProfile($userId: uuid!, $changes: user_profiles_set_input!) {
  update_user_profiles_by_pk(pk_columns: { user_id: $userId }, _set: $changes) {
    user_id
    role
    district_id
    school_id
    full_name
  }
}
`;function ae(){var C,$,k,U,T;const{data:t}=O(),c=(t==null?void 0:t.role)==="system_admin"||(t==null?void 0:t.role)==="admin",w=V(),{toast:_}=H(),g=G(w,["users:manage"]),i=g,[r,f]=l.useState(""),[h,p]=l.useState("all"),[n,u]=l.useState(0),j=25,m=l.useMemo(()=>{const s=[];return r!=null&&r.trim()&&s.push({full_name:{_ilike:`%${r.trim()}%`}}),h!=="all"&&s.push({role:{_eq:h}}),c||(t!=null&&t.schoolId?s.push({school_id:{_eq:t.schoolId}}):t!=null&&t.districtId&&s.push({district_id:{_eq:t.districtId}})),s.length?{_and:s}:{}},[r,h,c,t==null?void 0:t.districtId,t==null?void 0:t.schoolId]),o=J({queryKey:["admin_users",m,n],enabled:!!(t!=null&&t.userId),queryFn:async()=>{const s=await A(Y,{where:m,limit:j,offset:n*j});if(s.error)throw s.error;return s.data}}),N=E({mutationFn:async({userId:s,changes:x})=>{const d=await A(W,{userId:s,changes:x});if(d.error)throw d.error;return d.data},onSuccess:()=>o.refetch()}),a=E({mutationFn:async s=>{const x=await K.auth.getAccessToken(),d=await fetch("/api/admin/impersonations",{method:"POST",headers:{"Content-Type":"application/json",...x?{Authorization:`Bearer ${x}`}:{}},body:JSON.stringify({userId:s})});if(!d.ok){const Q=await d.text();throw new Error(Q||"Failed to start impersonation")}return d.json()},onSuccess:s=>{_({title:"Impersonation ready",description:`Token created (expires ${(s==null?void 0:s.expiresAt)||"soon"}).`})},onError:s=>{_({variant:"destructive",title:"Impersonation failed",description:s instanceof Error?s.message:"Unable to start impersonation."})}}),S=((k=($=(C=o.data)==null?void 0:C.user_profiles_aggregate)==null?void 0:$.aggregate)==null?void 0:k.count)??0,y=Math.max(1,Math.ceil(S/j));return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Users"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Tenant-scoped user profile administration (backed by Hasura GraphQL, enforced by DB RLS)."})]}),e.jsxs(R,{children:[e.jsx(D,{children:e.jsx(F,{children:"Search & Filter"})}),e.jsxs(P,{className:"flex flex-col md:flex-row gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(v,{value:r,onChange:s=>f(s.target.value),placeholder:"Search by full name"})}),e.jsx("div",{className:"w-full md:w-56",children:e.jsxs(B,{value:h,onValueChange:p,children:[e.jsx(q,{children:e.jsx(L,{placeholder:"All roles"})}),e.jsxs(M,{children:[e.jsx(I,{value:"all",children:"All roles"}),z.map(s=>e.jsx(I,{value:s,children:s},s))]})]})})]})]}),e.jsxs(R,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between",children:[e.jsx(F,{children:"User profiles"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[S," total"]})]}),e.jsxs(P,{children:[o.isLoading?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading usersâ€¦"}):(T=(U=o.data)==null?void 0:U.user_profiles)!=null&&T.length?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b text-left",children:[e.jsx("th",{className:"p-2",children:"Name"}),e.jsx("th",{className:"p-2",children:"User ID"}),e.jsx("th",{className:"p-2",children:"Role"}),e.jsx("th",{className:"p-2",children:"District"}),e.jsx("th",{className:"p-2",children:"School"}),e.jsx("th",{className:"p-2"})]})}),e.jsx("tbody",{children:o.data.user_profiles.map(s=>e.jsx(X,{user:s,isSystem:c,onSave:x=>N.mutate({userId:s.user_id,changes:x}),onImpersonate:()=>a.mutate(s.user_id),saving:N.isPending,canManageUsers:g,canImpersonate:i},s.user_id))})]})}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No users match the current filters."}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Page ",n+1," of ",y]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{variant:"secondary",size:"sm",disabled:n===0,onClick:()=>u(s=>Math.max(0,s-1)),children:"Prev"}),e.jsx(b,{variant:"secondary",size:"sm",disabled:n+1>=y,onClick:()=>u(s=>Math.min(y-1,s+1)),children:"Next"})]})]})]})]})]})}function X({user:t,isSystem:c,onSave:w,onImpersonate:_,saving:g,canManageUsers:i,canImpersonate:r}){const[f,h]=l.useState(t.role??"parent"),[p,n]=l.useState(t.district_id??""),[u,j]=l.useState(t.school_id??""),[m,o]=l.useState(t.full_name??""),N=f!==(t.role??"parent")||p!==(t.district_id??"")||u!==(t.school_id??"")||m!==(t.full_name??"");return e.jsxs("tr",{className:"border-b align-top",children:[e.jsx("td",{className:"p-2",children:e.jsx(v,{value:m,onChange:a=>o(a.target.value),disabled:!i})}),e.jsx("td",{className:"p-2 font-mono text-xs whitespace-nowrap",children:t.user_id}),e.jsx("td",{className:"p-2",children:e.jsxs(B,{value:f,onValueChange:h,disabled:!i,children:[e.jsx(q,{children:e.jsx(L,{placeholder:"Role"})}),e.jsx(M,{children:z.map(a=>e.jsx(I,{value:a,children:a},a))})]})}),e.jsx("td",{className:"p-2",children:e.jsx(v,{value:p,onChange:a=>n(a.target.value),disabled:!i||!c&&!!t.district_id,placeholder:"District UUID"})}),e.jsx("td",{className:"p-2",children:e.jsx(v,{value:u,onChange:a=>j(a.target.value),disabled:!i||!c&&!!t.school_id,placeholder:"School UUID"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(b,{size:"sm",disabled:!N||g||!i,onClick:()=>w({role:f,district_id:p||null,school_id:u||null,full_name:m||null}),children:"Save"}),r?e.jsx(b,{size:"sm",variant:"secondary",onClick:_,children:"Impersonate"}):null]})})]})}export{ae as default};
//# sourceMappingURL=AdminUsers-DkBpnuY8.js.map
