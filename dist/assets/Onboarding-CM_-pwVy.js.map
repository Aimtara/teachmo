{"version":3,"file":"Onboarding-CM_-pwVy.js","sources":["../../src/pages/Onboarding.jsx"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\nimport { useAuthenticationStatus, useUserData } from '@nhost/react';\nimport { useNavigate } from 'react-router-dom';\nimport { bootstrapOrganization, completeOnboarding } from '@/domains/onboarding';\nimport { getDefaultPathForRole, useUserRoleState } from '@/hooks/useUserRole';\nimport { trackEvent } from '@/observability/telemetry';\nimport { useTenantScope } from '@/hooks/useTenantScope';\nimport { nhost } from '@/lib/nhostClient';\n\nexport default function Onboarding() {\n  const { isAuthenticated, isLoading } = useAuthenticationStatus();\n  const user = useUserData();\n  const navigate = useNavigate();\n  const { role, loading: roleLoading, needsOnboarding } = useUserRoleState();\n  const tenant = useTenantScope();\n\n  const isPrivilegedBootstrap = useMemo(\n    () => role === 'system_admin' || role === 'admin',\n    [role]\n  );\n  const allowTenantBootstrap = Boolean(\n    isPrivilegedBootstrap && (!tenant.data?.organizationId || !tenant.data?.schoolId)\n  );\n\n  const [form, setForm] = useState({\n    fullName: '',\n    organizationName: 'Demo District',\n    schoolName: 'Demo School'\n  });\n  const [status, setStatus] = useState('');\n  const [error, setError] = useState('');\n\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    if (isLoading || roleLoading || tenant.isLoading) return;\n    // If the user is already onboarded, bounce them to their default home.\n    if (!needsOnboarding) navigate(getDefaultPathForRole(role), { replace: true });\n  }, [isAuthenticated, isLoading, roleLoading, tenant.isLoading, needsOnboarding, role, navigate]);\n\n  if (isLoading || roleLoading || tenant.isLoading) {\n    return <div className=\"p-6 text-center text-sm text-muted-foreground\">Loading…</div>;\n  }\n\n  if (!isAuthenticated) return <p className=\"p-6\">Please sign in to start onboarding.</p>;\n\n  const handleChange = (evt) => {\n    setForm({ ...form, [evt.target.name]: evt.target.value });\n  };\n\n  const handleSubmit = async (evt) => {\n    evt.preventDefault();\n    setStatus(allowTenantBootstrap ? 'Setting up your organization…' : 'Saving your profile…');\n    setError('');\n\n    void trackEvent({\n      eventName: 'onboarding.started',\n      entityType: 'user',\n      entityId: user?.id,\n      metadata: allowTenantBootstrap\n        ? { role, organizationName: form.organizationName, schoolName: form.schoolName }\n        : { role },\n    });\n\n    try {\n      let org = null;\n      if (allowTenantBootstrap) {\n        org = await bootstrapOrganization({\n          organizationName: form.organizationName,\n          schoolName: form.schoolName\n        });\n      }\n\n      setStatus('Updating your profile…');\n      await completeOnboarding({\n        userId: user?.id,\n        fullName: form.fullName,\n        organizationId: org?.organization?.id ?? tenant.data?.organizationId ?? null,\n        schoolId: org?.school?.id ?? tenant.data?.schoolId ?? null,\n        allowTenantWrite: Boolean(allowTenantBootstrap && org?.organization?.id)\n      });\n\n      await nhost.auth.refreshSession();\n\n      void trackEvent({\n        eventName: 'onboarding.completed',\n        entityType: 'user',\n        entityId: user?.id,\n        metadata: {\n          role,\n          organizationId: org?.organization?.id ?? tenant.data?.organizationId ?? null,\n          schoolId: org?.school?.id ?? tenant.data?.schoolId ?? null\n        },\n      });\n\n      setStatus('Onboarding complete! Redirecting…');\n      navigate(getDefaultPathForRole(role), { replace: true });\n    } catch (err) {\n      console.error(err);\n      setError(err.message);\n      setStatus('');\n\n      void trackEvent({\n        eventName: 'onboarding.failed',\n        entityType: 'user',\n        entityId: user?.id,\n        metadata: { message: err?.message || 'unknown' },\n      });\n    }\n  };\n\n  return (\n    <div className=\"max-w-2xl mx-auto p-8\">\n      <h1 className=\"text-3xl font-semibold mb-4\">Welcome to Teachmo</h1>\n      <p className=\"text-gray-600 mb-6\">Tell us about yourself so we can set up your workspace.</p>\n\n      <form onSubmit={handleSubmit} className=\"space-y-4 bg-white shadow rounded p-6\">\n        <label className=\"block\">\n          <span className=\"text-sm font-medium text-gray-700\">Full name</span>\n          <input\n            name=\"fullName\"\n            value={form.fullName}\n            onChange={handleChange}\n            className=\"mt-1 w-full border rounded px-3 py-2\"\n            required\n          />\n        </label>\n\n        <div className=\"rounded border bg-gray-50 p-3 text-sm text-gray-700\">\n          <div className=\"font-medium\">Detected role</div>\n          <div className=\"mt-1\">{role}</div>\n          {!allowTenantBootstrap && (\n            <p className=\"mt-2 text-xs text-gray-600\">\n              Your organization and school are assigned by your invitation/tenant configuration.\n            </p>\n          )}\n        </div>\n\n        {allowTenantBootstrap && (\n          <>\n            <label className=\"block\">\n              <span className=\"text-sm font-medium text-gray-700\">Organization</span>\n              <input\n                name=\"organizationName\"\n                value={form.organizationName}\n                onChange={handleChange}\n                className=\"mt-1 w-full border rounded px-3 py-2\"\n                required\n              />\n            </label>\n\n            <label className=\"block\">\n              <span className=\"text-sm font-medium text-gray-700\">School</span>\n              <input\n                name=\"schoolName\"\n                value={form.schoolName}\n                onChange={handleChange}\n                className=\"mt-1 w-full border rounded px-3 py-2\"\n                required\n              />\n            </label>\n          </>\n        )}\n\n        <button\n          type=\"submit\"\n          className=\"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700\"\n        >\n          Complete onboarding\n        </button>\n\n        {status && <p className=\"text-sm text-green-700\">{status}</p>}\n        {error && <p className=\"text-sm text-red-700\">{error}</p>}\n      </form>\n    </div>\n  );\n}\n"],"names":["Onboarding","isAuthenticated","isLoading","useAuthenticationStatus","user","useUserData","navigate","useNavigate","role","roleLoading","needsOnboarding","useUserRoleState","tenant","useTenantScope","allowTenantBootstrap","useMemo","_a","_b","form","setForm","useState","status","setStatus","error","setError","useEffect","getDefaultPathForRole","jsx","handleChange","evt","handleSubmit","trackEvent","org","bootstrapOrganization","completeOnboarding","_c","_d","_e","nhost","_f","_g","_h","_i","err","jsxs","Fragment"],"mappings":"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"}