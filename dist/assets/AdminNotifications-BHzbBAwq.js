import{h as W,r as c,G as p,j as e,C as v,i as f,k as y,o as S,B as X,e as m,n as Z}from"./index-BPP-_OMN.js";import{u as U}from"./useMutation-CMiQkM4s.js";import{I as k}from"./input-DXyqFpUo.js";import{T as L}from"./textarea-Be6YKw6o.js";import{C as ee}from"./checkbox-L0Xbs-7k.js";import{L as n}from"./label-BYGjLjtR.js";import{S as se,a as te,b as ne,c as ae,d as w}from"./select-45VgWSkf.js";import{S as N}from"./switch-CC0KUM4c.js";import"./check-BnYO2CVa.js";const ie=[{value:"parent",label:"Parents"},{value:"teacher",label:"Teachers"},{value:"school_admin",label:"School admins"},{value:"district_admin",label:"District admins"},{value:"system_admin",label:"System admins"}];async function u(i,d={}){const r=await fetch(i,d);if(!r.ok){const h=await r.text();throw new Error(h||"Request failed")}return r.json()}function J(i){return i.split(",").map(d=>d.trim()).filter(Boolean)}function ge(){var E,R,P,B,O,Q,$,K;const{toast:i}=W(),[d,r]=c.useState("email"),[h,_]=c.useState(""),[F,T]=c.useState(""),[b,D]=c.useState(""),[I,z]=c.useState(""),[M,V]=c.useState(""),[A,G]=c.useState(new Set(["parent","teacher"])),o=p({queryKey:["notification_headers"],queryFn:async()=>{const s=await Z.auth.getAccessToken();return{"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{}}}}),C=p({queryKey:["admin_announcements"],queryFn:async()=>u(`${m}/admin/notifications/announcements`,{headers:o.data})}),H=p({queryKey:["admin_notification_metrics",d],queryFn:async()=>u(`${m}/admin/notifications/metrics?channel=${d}`,{headers:o.data})}),x=p({queryKey:["admin_notification_settings"],queryFn:async()=>u(`${m}/tenants/settings`,{headers:o.data})}),t=c.useMemo(()=>{var l,a;return(((a=(l=x.data)==null?void 0:l.settings)==null?void 0:a.settings)||{}).notifications||{}},[x.data]),Y=s=>{G(l=>{const a=new Set(l);return a.has(s)?a.delete(s):a.add(s),a})},q=U({mutationFn:async()=>{const s={channel:d,title:h,body:F,send_at:b?new Date(b).toISOString():null,segment:{roles:Array.from(A),user_ids:J(I),school_ids:J(M)}};return u(`${m}/admin/notifications/announcements`,{method:"POST",headers:o.data,body:JSON.stringify(s)})},onSuccess:()=>{i({title:"Announcement queued",description:"Your notification is now in the delivery queue."}),_(""),T(""),D(""),C.refetch()},onError:s=>{i({variant:"destructive",title:"Unable to send",description:s instanceof Error?s.message:"Failed to create announcement."})}}),g=U({mutationFn:async s=>{var a;const l=((a=x.data)==null?void 0:a.settings)||{};return u(`${m}/tenants/settings`,{method:"PUT",headers:o.data,body:JSON.stringify({branding:l.branding||{},settings:{...l.settings||{},notifications:s}})})},onSuccess:()=>{i({title:"Deliverability settings saved",description:"Tenant validation settings are updated."}),x.refetch()},onError:s=>{i({variant:"destructive",title:"Save failed",description:s instanceof Error?s.message:"Unable to update settings."})}}),j=((E=H.data)==null?void 0:E.metrics)||{};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Notifications"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Queue tenant-wide or segmented announcements and monitor deliverability signals."})]}),e.jsxs(v,{children:[e.jsx(f,{children:e.jsx(y,{children:"Deliverability Settings"})}),e.jsx(S,{className:"space-y-4 text-sm",children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{htmlFor:"spf-toggle",children:"SPF validated"}),e.jsx(N,{id:"spf-toggle",checked:((R=t.email)==null?void 0:R.spf)==="pass",onCheckedChange:s=>g.mutate({...t,email:{...t.email,spf:s?"pass":"fail"}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{htmlFor:"dkim-toggle",children:"DKIM validated"}),e.jsx(N,{id:"dkim-toggle",checked:((P=t.email)==null?void 0:P.dkim)==="pass",onCheckedChange:s=>g.mutate({...t,email:{...t.email,dkim:s?"pass":"fail"}})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{htmlFor:"dmarc-toggle",children:"DMARC validated"}),e.jsx(N,{id:"dmarc-toggle",checked:((B=t.email)==null?void 0:B.dmarc)==="pass",onCheckedChange:s=>g.mutate({...t,email:{...t.email,dmarc:s?"pass":"fail"}})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{htmlFor:"sms-toggle",children:"SMS opt-in enabled"}),e.jsx(N,{id:"sms-toggle",checked:((O=t.sms)==null?void 0:O.opt_in)===!0,onCheckedChange:s=>g.mutate({...t,sms:{...t.sms,opt_in:s}})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"SPF/DKIM/DMARC must pass to send email; SMS opt-in is required for SMS delivery."})]})]})})]}),e.jsxs(v,{children:[e.jsx(f,{children:e.jsx(y,{children:"Announcement Composer"})}),e.jsxs(S,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"announcement-title",children:"Title"}),e.jsx(k,{id:"announcement-title",value:h,onChange:s=>_(s.target.value),placeholder:"Quarterly update"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Channel"}),e.jsxs(se,{value:d,onValueChange:r,children:[e.jsx(te,{children:e.jsx(ne,{placeholder:"Select channel"})}),e.jsxs(ae,{children:[e.jsx(w,{value:"email",children:"Email"}),e.jsx(w,{value:"sms",children:"SMS"}),e.jsx(w,{value:"push",children:"Push"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"announcement-body",children:"Message"}),e.jsx(L,{id:"announcement-body",value:F,onChange:s=>T(s.target.value),rows:4,placeholder:"Share an update with your community..."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"announcement-sendat",children:"Scheduled send time"}),e.jsx(k,{id:"announcement-sendat",type:"datetime-local",value:b,onChange:s=>D(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"announcement-school",children:"School IDs (optional)"}),e.jsx(k,{id:"announcement-school",value:M,onChange:s=>V(s.target.value),placeholder:"uuid, uuid"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Target roles"}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-3",children:ie.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{checked:A.has(s.value),onCheckedChange:()=>Y(s.value)}),s.label]},s.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"announcement-users",children:"Specific user IDs (optional)"}),e.jsx(L,{id:"announcement-users",value:I,onChange:s=>z(s.target.value),rows:2,placeholder:"uuid, uuid"})]}),e.jsx(X,{onClick:()=>q.mutate(),disabled:q.isPending,children:"Queue announcement"})]})]}),e.jsxs(v,{children:[e.jsx(f,{children:e.jsx(y,{children:"Deliverability Metrics"})}),e.jsxs(S,{className:"grid gap-4 md:grid-cols-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Delivered"}),e.jsx("div",{className:"text-lg font-semibold",children:j.delivered||0})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Bounced"}),e.jsx("div",{className:"text-lg font-semibold",children:j.bounced||0})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Opened"}),e.jsx("div",{className:"text-lg font-semibold",children:j.opened||0})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Clicked"}),e.jsx("div",{className:"text-lg font-semibold",children:j.clicked||0})]})]})]}),e.jsxs(v,{children:[e.jsx(f,{children:e.jsx(y,{children:"Recent Announcements"})}),e.jsxs(S,{className:"space-y-4 text-sm",children:[(((Q=C.data)==null?void 0:Q.announcements)||[]).map(s=>e.jsxs("div",{className:"border rounded-md p-4 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:s.title||"Untitled announcement"}),e.jsx("div",{className:"text-xs uppercase text-muted-foreground",children:s.status})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.channel," • scheduled ",s.send_at?new Date(s.send_at).toLocaleString():"now"]}),e.jsx("p",{children:s.body}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Delivered ",s.sent_count||0," • Bounced ",s.bounced_count||0]})]},s.id)),((K=($=C.data)==null?void 0:$.announcements)==null?void 0:K.length)===0&&e.jsx("p",{className:"text-muted-foreground",children:"No announcements yet."})]})]})]})}export{ge as default};
//# sourceMappingURL=AdminNotifications-BHzbBAwq.js.map
