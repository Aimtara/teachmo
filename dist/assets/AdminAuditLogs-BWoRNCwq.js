import{b as w,r as y,G as C,j as e,C as j,i as p,k as g,o as b,B as L,I as v,n as I,J as N,y as T}from"./index-BPP-_OMN.js";import{I as q}from"./input-DXyqFpUo.js";import{T as S,a as A,b as h,c as u,d as E,e as d}from"./table-C5y0xJGn.js";const R=N("admin-audit-logs");function B(){const{data:s}=w(),i=(s==null?void 0:s.organizationId)??null,c=(s==null?void 0:s.schoolId)??null,[l,f]=y.useState(""),x=C({queryKey:["audit-log",i,c],enabled:!!i,queryFn:async()=>{const a=await T(`query AuditLog($where: audit_log_bool_exp!, $limit: Int!) {
        audit_log(where: $where, order_by: { created_at: desc }, limit: $limit) {
          id
          created_at
          actor_id
          action
          entity_type
          entity_id
          metadata
          organization_id
          school_id
        }
      }`,{where:c?{school_id:{_eq:c}}:{organization_id:{_eq:i}},limit:200});return(a==null?void 0:a.audit_log)??[]}}),m=y.useMemo(()=>{const t=l.trim().toLowerCase();return t?(x.data??[]).filter(r=>{var a,n;return((a=r.action)==null?void 0:a.toLowerCase().includes(t))||((n=r.entity_type)==null?void 0:n.toLowerCase().includes(t))}):x.data??[]},[x.data,l]),_=async()=>{const{res:t,error:r}=await I.functions.call("audit-export",{search:l,organizationId:i,schoolId:c});if(r){R.error("Audit export failed",r);return}const a=await t.blob(),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download=`audit-logs-${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(n)};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Audit Logs"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"View immutable audit records for security-sensitive activity. Filters apply to your tenant scope."})]}),e.jsxs(j,{children:[e.jsx(p,{children:e.jsx(g,{children:"Search & Export"})}),e.jsxs(b,{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsx(q,{value:l,onChange:t=>f(t.target.value),placeholder:"Filter by action or entity",className:"md:max-w-sm"}),e.jsx(L,{onClick:_,disabled:!i,children:"Export CSV"})]})]}),e.jsxs(j,{children:[e.jsx(p,{children:e.jsx(g,{children:"Recent Entries"})}),e.jsx(b,{children:e.jsxs(S,{children:[e.jsx(A,{children:e.jsxs(h,{children:[e.jsx(u,{children:"Date"}),e.jsx(u,{children:"Action"}),e.jsx(u,{children:"Entity"}),e.jsx(u,{children:"Actor"})]})}),e.jsx(E,{children:m.length===0?e.jsx(h,{children:e.jsx(d,{colSpan:4,className:"text-sm text-muted-foreground",children:"No audit records found."})}):m.map(t=>e.jsxs(h,{children:[e.jsx(d,{className:"whitespace-nowrap",children:t.created_at?v(new Date(t.created_at),"MMM d, yyyy p"):"â€”"}),e.jsx(d,{children:t.action}),e.jsx(d,{children:t.entity_type}),e.jsx(d,{className:"font-mono text-xs",children:t.actor_id??"system"})]},t.id))})]})})]})]})}export{B as default};
//# sourceMappingURL=AdminAuditLogs-BWoRNCwq.js.map
