import{c as j,e as te,T as E,G as se,f as D,Y as ne,r as h,j as e,i as ae,k as oe,B as k,a8 as re,a9 as A,o as ie,aA as ce,l as le,C as de}from"./index-BPP-_OMN.js";import{T as ue}from"./textarea-Be6YKw6o.js";import{B as me}from"./badge-BdaYTYbY.js";import{f as P,g as he}from"./client-Dq7aaYpM.js";import{A as ge}from"./index-y6jvPR9A.js";import{U as B}from"./users-gkI5qxSk.js";import{B as L}from"./book-open-BvSkT0ax.js";import{S as O}from"./sparkles-D1zPXSma.js";import{C as pe}from"./circle-alert-BmD3VFMm.js";import{L as fe}from"./loader-circle-CPuSJKcI.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],F=j("Bot",xe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]],U=j("Lightbulb",ye);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],be=j("Send",we);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]],ve=j("ThumbsDown",je);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],ke=j("ThumbsUp",Ne);function M(t){return new Promise((s,n)=>{t.oncomplete=t.onsuccess=()=>s(t.result),t.onabort=t.onerror=()=>n(t.error)})}function H(t,s){let n;const r=()=>{if(n)return n;const a=indexedDB.open(t);return a.onupgradeneeded=()=>a.result.createObjectStore(s),n=M(a),n.then(c=>{c.onclose=()=>n=void 0},()=>{}),n};return(a,c)=>r().then(o=>c(o.transaction(s,a).objectStore(s)))}let _;function Q(){return _||(_=H("keyval-store","keyval")),_}function Ie(t,s=Q()){return s("readonly",n=>M(n.get(t)))}function Se(t,s,n=Q()){return n("readwrite",r=>(r.put(s,t),M(r.transaction)))}const K=H("teachmo-offline","outbox"),V="queue";async function _e(){return await Ie(V,K)||[]}async function Ae(t){await Se(V,t,K)}async function Me(t){const s=await _e(),n=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`,r={...t,id:n,createdAt:new Date().toISOString()};return s.push(r),await Ae(s),r}async function Te(t,s){try{return await P("/ai/log",{method:"POST",body:JSON.stringify(s)})}catch(n){if(typeof navigator<"u"&&navigator.onLine===!1){const r=await he();return await Me({url:`${te}/ai/log`,method:"POST",headers:r,body:JSON.stringify(s)}),{queued:!0}}throw n}}async function qe(t){return P("/ai/resolve-model",{method:"POST",body:JSON.stringify(t)})}const Ce=["definitely","certainly","guaranteed","always","never","proven","100%"];function $e(t,s){const n=t.match(s);return n?n.length:0}function R(t){return t?Math.max(1,Math.ceil(t.trim().length/4)):0}function ze(t){if(!t)return{score:0,flags:[]};const s=[],n=/\d+[%]?\b/g.test(t),r=Ce.some(f=>t.toLowerCase().includes(f)),a=/(http|https|source|according to|study|report)/i.test(t),c=$e(t,/\b[A-Z][a-z]+\b/g);let o=.1;return n&&(o+=.2,s.push("numeric_claims")),r&&(o+=.2,s.push("high_confidence_language")),a||(o+=.2,s.push("missing_sources")),c>=6&&(o+=.2,s.push("many_named_entities")),o=Math.min(1,Math.max(0,o)),{score:o,flags:s}}function De(){const t=E(),s=(t==null?void 0:t.id)??null;return se({queryKey:["tenant-feature-flags",s],enabled:!!s,queryFn:async()=>{var x;if(!s)return{};const r=await D({query:`query MyProfile($userId: uuid!) {
        profiles(where: { user_id: { _eq: $userId } }, limit: 1) {
          organization_id
          school_id
        }
      }`,variables:{userId:s}}),a=(x=r==null?void 0:r.profiles)==null?void 0:x[0],c=(a==null?void 0:a.organization_id)??null,o=(a==null?void 0:a.school_id)??null;if(!c)return{};const u=await D({query:`query TenantFeatureFlags($orgId: uuid!, $schoolId: uuid) {
        feature_flags(
          where: {
            organization_id: { _eq: $orgId },
            _or: [
              { school_id: { _eq: $schoolId } },
              { school_id: { _is_null: true } }
            ]
          }
        ) {
          key
          enabled
        }
      }`,variables:{orgId:c,schoolId:o}});return((u==null?void 0:u.feature_flags)??[]).reduce((g,v)=>(g[v.key]=!!v.enabled,g),{})}})}const N=({icon:t,label:s,description:n})=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(t,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:s}),e.jsx("p",{className:"text-xs text-blue-700",children:n})]})]}),Re=({message:t,isUser:s,onFeedback:n,timestamp:r,confidence:a,sources:c})=>{const[o,f]=h.useState(null),u=m=>{f(m),n==null||n(t.id,m)};return e.jsxs(A.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`flex gap-3 mb-4 ${s?"justify-end":"justify-start"}`,children:[!s&&e.jsx("div",{className:"w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(F,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:`max-w-[80%] ${s?"order-first":""}`,children:[e.jsxs("div",{className:`rounded-lg p-3 ${s?"bg-blue-600 text-white ml-auto":"bg-gray-100 text-gray-900"}`,children:[e.jsx("div",{className:"prose prose-sm max-w-none",children:typeof t.content=="string"?e.jsx("p",{className:"whitespace-pre-wrap",children:t.content}):t.content}),!s&&e.jsxs("div",{className:"mt-3 space-y-2",children:[a&&e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${a>.8?"bg-green-500":a>.6?"bg-yellow-500":"bg-red-500"}`}),e.jsx("span",{children:a>.8?"High confidence":a>.6?"Medium confidence":"Lower confidence"})]})}),c&&c.length>0&&e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium mb-1",children:"Sources:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:c.map((m,x)=>e.jsx(me,{variant:"outline",className:"text-xs",children:m},x))})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t border-gray-200",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Was this helpful?"}),e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>u("positive"),className:`h-6 px-2 ${o==="positive"?"bg-green-100 text-green-700":""}`,children:e.jsx(ke,{className:"w-3 h-3"})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>u("negative"),className:`h-6 px-2 ${o==="negative"?"bg-red-100 text-red-700":""}`,children:e.jsx(ve,{className:"w-3 h-3"})})]})]})]}),r&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 px-1",children:new Date(r).toLocaleTimeString()})]}),s&&e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(B,{className:"w-4 h-4 text-gray-600"})})]})},Ee=({stage:t})=>{const s=[{key:"analyzing",label:"Analyzing your question...",icon:O},{key:"researching",label:"Researching relevant information...",icon:L},{key:"formulating",label:"Formulating response...",icon:U}],n=s.find(a=>a.key===t)||s[0],r=n.icon;return e.jsxs(A.div,{initial:{opacity:0},animate:{opacity:1},className:"flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(r,{className:"w-4 h-4 text-blue-600 animate-pulse"}),e.jsx("span",{className:"text-sm text-blue-800",children:n.label})]})};function Pe({user:t,children:s}){const n=ne(),r=De(),[a,c]=h.useState([]),[o,f]=h.useState(""),[u,m]=h.useState(!1),[x,g]=h.useState(null),[v,T]=h.useState(!a.length),q=h.useRef(null),G=()=>{var i;(i=q.current)==null||i.scrollIntoView({behavior:"smooth"})};h.useEffect(()=>{G()},[a,u]),h.useEffect(()=>{if(a.length===0){const i={id:"welcome",content:`Hi! I'm your AI assistant. I'm here to help with parenting questions, activity suggestions, and homework support. I provide general guidance based on research and best practices, but I'm not a substitute for professional medical or therapeutic advice.

What would you like help with today?`,isUser:!1,timestamp:new Date().toISOString(),confidence:.95};c([i])}},[]);const C=async()=>{if(!o.trim()||u)return;const i={id:Date.now().toString(),content:o,isUser:!0,timestamp:new Date().toISOString()};c(y=>[...y,i]),f(""),m(!0),T(!1);try{const y=Date.now();g("analyzing"),await new Promise(d=>setTimeout(d,800)),g("researching"),await new Promise(d=>setTimeout(d,1e3)),g("formulating"),await new Promise(d=>setTimeout(d,600));const w=R(o),I=r.data??{};let b={allowed:!0,model:"gpt-4o-mini",reason:"default"};try{b=await qe({preferredModel:w>300?"gpt-4o":"gpt-4o-mini",estimatedTokens:w,featureFlags:I})}catch(d){console.warn("AI model resolution failed, using default model.",d)}if(!b.allowed){c(d=>[...d,{id:Date.now().toString()+"_blocked",content:"Your organization's AI budget has been reached. Please try again later or contact an administrator.",isUser:!1,timestamp:new Date().toISOString(),confidence:.1}]),m(!1),g(null);return}const $={user_type:t==null?void 0:t.user_type,children:s||[],conversation_history:a.slice(-5)},l=await ce({query:o,context:$,model:b.model}),W={id:Date.now().toString()+"_ai",content:l.response,isUser:!1,timestamp:new Date().toISOString(),confidence:l.confidence||.8,sources:l.sources||[]};if(c(d=>[...d,W]),n.organizationId){const d=R(l.response),z=w+d,p=ze(l.response),X=Array.isArray(s)&&s.length?String(s[0].id||s[0].childId||""):null,S=p.score>=.7,ee=S?`Risk score ${p.score}${p.flags.length?` (${p.flags.join(", ")})`:""}`:null;Promise.allSettled([Te({organizationId:n.organizationId,schoolId:n.schoolId},{prompt:o,response:l.response,tokenPrompt:w,tokenResponse:d,tokenTotal:z,safetyRiskScore:p.score,safetyFlags:p.flags,model:l.model||l.provider||b.model||"unknown",metadata:{confidence:l.confidence,sources:l.sources,modelReason:b.reason,budgetExceeded:b.budgetExceeded},childId:X,inputs:{query:o,context:$},outputs:{response:l.response,confidence:l.confidence,sources:l.sources},reviewRequired:S,reviewReason:ee,latencyMs:Date.now()-y}),le({organizationId:n.organizationId,schoolId:n.schoolId},{eventName:"ai_call",metadata:{tokenPrompt:w,tokenResponse:d,tokenTotal:z,safetyRiskScore:p.score,safetyFlags:p.flags,model:l.model||l.provider||b.model||"unknown",reviewRequired:S}})]).catch(()=>{})}}catch(y){console.error("AI Assistant error:",y);const w={id:Date.now().toString()+"_error",content:"I'm sorry, I encountered an error processing your request. Please try again, or rephrase your question.",isUser:!1,timestamp:new Date().toISOString(),confidence:.1};c(I=>[...I,w])}finally{m(!1),g(null)}},J=async(i,y)=>{console.log(`Feedback for message ${i}: ${y}`)},Y=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),C())},Z=()=>{c([]),T(!0)};return e.jsxs("div",{className:"flex flex-col h-full max-h-[80vh]",children:[e.jsx(ae,{className:"border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:e.jsx(F,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx(oe,{className:"text-lg",children:"AI Assistant"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Your personal parenting guide"})]})]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:Z,children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"New Chat"]})]})}),e.jsx(ge,{children:v&&e.jsxs(A.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"p-4 border-b bg-gray-50",children:[e.jsx("h3",{className:"font-medium text-sm mb-3 text-gray-800",children:"I can help you with:"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(N,{icon:B,label:"Parenting Guidance",description:"Age-appropriate strategies and tips"}),e.jsx(N,{icon:L,label:"Homework Support",description:"Learning strategies and explanations"}),e.jsx(N,{icon:O,label:"Activity Suggestions",description:"Personalized recommendations"}),e.jsx(N,{icon:U,label:"Development Insights",description:"Understanding your child's growth"})]}),e.jsx("div",{className:"mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(pe,{className:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("p",{className:"text-xs text-yellow-800",children:[e.jsx("strong",{children:"Important:"})," I provide general guidance based on research and cannot replace professional medical, therapeutic, or educational advice. Always consult qualified professionals for specific concerns."]})]})})]})}),e.jsxs(ie,{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[a.map(i=>e.jsx(Re,{message:i,isUser:i.isUser,onFeedback:J,timestamp:i.timestamp,confidence:i.confidence,sources:i.sources},i.id)),u&&x&&e.jsx(Ee,{stage:x}),e.jsx("div",{ref:q})]}),e.jsx("div",{className:"border-t p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ue,{value:o,onChange:i=>f(i.target.value),onKeyPress:Y,placeholder:"Ask me anything about parenting, activities, or homework help...",className:"resize-none",rows:2,disabled:u}),e.jsx(k,{onClick:C,disabled:!o.trim()||u,className:"px-4",children:u?e.jsx(fe,{className:"w-4 h-4 animate-spin"}):e.jsx(be,{className:"w-4 h-4"})})]})})]})}function Je(){const t=E();return e.jsx("div",{className:"p-6",children:e.jsx(de,{className:"max-w-5xl mx-auto",children:e.jsx(Pe,{user:t})})})}export{Je as default};
//# sourceMappingURL=AIAssistant-ePn1Qr6e.js.map
