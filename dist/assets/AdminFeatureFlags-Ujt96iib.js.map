{"version":3,"file":"AdminFeatureFlags-Ujt96iib.js","sources":["../../src/pages/AdminFeatureFlags.jsx"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { useTenantScope } from '@/hooks/useTenantScope';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Switch } from '@/components/ui/switch';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport {\n  fetchAdminFeatureFlags,\n  joinList,\n  splitList,\n  updateAdminFeatureFlag,\n} from '@/utils/featureFlagClient';\n\nconst EMPTY_FLAGS = [];\n\nfunction buildDraft(flag) {\n  return {\n    enabled: Boolean(flag.enabled ?? flag.defaultEnabled ?? false),\n    description: flag.description ?? '',\n    rolloutPercentage: flag.rolloutPercentage ?? '',\n    canaryPercentage: flag.canaryPercentage ?? '',\n    allowlistText: joinList(flag.allowlist),\n    denylistText: joinList(flag.denylist),\n  };\n}\n\nexport default function AdminFeatureFlags() {\n  const { data: scope } = useTenantScope();\n  const organizationId = scope?.organizationId ?? null;\n  const schoolId = scope?.schoolId ?? null;\n  const [newKey, setNewKey] = useState('');\n  const [newDescription, setNewDescription] = useState('');\n  const [drafts, setDrafts] = useState({});\n\n  const flagsQuery = useQuery({\n    queryKey: ['feature-flags-admin', organizationId, schoolId],\n    enabled: Boolean(organizationId),\n    queryFn: () => fetchAdminFeatureFlags({ organizationId, schoolId }),\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: updateAdminFeatureFlag,\n    onSuccess: () => flagsQuery.refetch(),\n  });\n\n  useEffect(() => {\n    if (!flagsQuery.data?.flags) return;\n    setDrafts(() => {\n      const next = {};\n      flagsQuery.data.flags.forEach((flag) => {\n        next[flag.key] = buildDraft(flag);\n      });\n      return next;\n    });\n  }, [flagsQuery.data]);\n\n  const groupedFlags = useMemo(() => flagsQuery.data?.flags ?? EMPTY_FLAGS, [flagsQuery.data]);\n\n  const updateDraft = (key, field, value) => {\n    setDrafts((prev) => ({\n      ...prev,\n      [key]: {\n        ...(prev[key] ?? buildDraft(groupedFlags.find((flag) => flag.key === key) || {})),\n        [field]: value,\n      },\n    }));\n  };\n\n  const handleSave = (key) => {\n    const draft = drafts[key];\n    if (!draft) return;\n    updateMutation.mutate({\n      key,\n      organizationId,\n      schoolId,\n      enabled: Boolean(draft.enabled),\n      description: draft.description?.trim() || null,\n      rolloutPercentage: draft.rolloutPercentage === '' ? null : Number(draft.rolloutPercentage),\n      canaryPercentage: draft.canaryPercentage === '' ? null : Number(draft.canaryPercentage),\n      allowlist: splitList(draft.allowlistText || ''),\n      denylist: splitList(draft.denylistText || ''),\n    });\n  };\n\n  const handleCreate = () => {\n    if (!newKey.trim()) return;\n    updateMutation.mutate({\n      key: newKey.trim(),\n      organizationId,\n      schoolId,\n      description: newDescription.trim() || null,\n      enabled: false,\n      rolloutPercentage: null,\n      canaryPercentage: null,\n      allowlist: [],\n      denylist: [],\n    });\n    setNewKey('');\n    setNewDescription('');\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\">Feature Flags</h1>\n        <p className=\"text-sm text-muted-foreground\">\n          Toggle enterprise capabilities per tenant. Percentage rollouts apply to user-based hashing, with allowlists\n          and denylists overriding staged rollouts. Updates are audited in the backend.\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Create Flag</CardTitle>\n        </CardHeader>\n        <CardContent className=\"grid gap-4 md:grid-cols-[2fr,3fr,auto]\">\n          <Input value={newKey} onChange={(event) => setNewKey(event.target.value)} placeholder=\"ENTERPRISE_SSO\" />\n          <Input\n            value={newDescription}\n            onChange={(event) => setNewDescription(event.target.value)}\n            placeholder=\"Description\"\n          />\n          <Button onClick={handleCreate} disabled={!newKey.trim() || updateMutation.isLoading || !organizationId}>\n            Add\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Flags</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Key</TableHead>\n                <TableHead>Description</TableHead>\n                <TableHead>Default</TableHead>\n                <TableHead>Enabled</TableHead>\n                <TableHead>Rollout %</TableHead>\n                <TableHead>Canary %</TableHead>\n                <TableHead>Allowlist</TableHead>\n                <TableHead>Denylist</TableHead>\n                <TableHead>Scope</TableHead>\n                <TableHead>Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {groupedFlags.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={10} className=\"text-sm text-muted-foreground\">\n                    No flags configured.\n                  </TableCell>\n                </TableRow>\n              ) : (\n                groupedFlags.map((flag) => {\n                  const draft = drafts[flag.key] ?? buildDraft(flag);\n                  return (\n                    <TableRow key={flag.key}>\n                      <TableCell className=\"font-mono text-xs\">{flag.key}</TableCell>\n                      <TableCell>\n                        <Input\n                          value={draft.description}\n                          onChange={(event) => updateDraft(flag.key, 'description', event.target.value)}\n                        />\n                      </TableCell>\n                      <TableCell>{flag.defaultEnabled ? 'On' : 'Off'}</TableCell>\n                      <TableCell>\n                        <Switch\n                          checked={Boolean(draft.enabled)}\n                          onCheckedChange={(checked) => updateDraft(flag.key, 'enabled', checked)}\n                          aria-label={`Toggle ${flag.key}`}\n                        />\n                      </TableCell>\n                      <TableCell>\n                        <Input\n                          type=\"number\"\n                          min=\"0\"\n                          max=\"100\"\n                          value={draft.rolloutPercentage}\n                          onChange={(event) => updateDraft(flag.key, 'rolloutPercentage', event.target.value)}\n                          placeholder=\"0-100\"\n                        />\n                      </TableCell>\n                      <TableCell>\n                        <Input\n                          type=\"number\"\n                          min=\"0\"\n                          max=\"100\"\n                          value={draft.canaryPercentage}\n                          onChange={(event) => updateDraft(flag.key, 'canaryPercentage', event.target.value)}\n                          placeholder=\"0-100\"\n                        />\n                      </TableCell>\n                      <TableCell>\n                        <Input\n                          value={draft.allowlistText}\n                          onChange={(event) => updateDraft(flag.key, 'allowlistText', event.target.value)}\n                          placeholder=\"tenant ids\"\n                        />\n                      </TableCell>\n                      <TableCell>\n                        <Input\n                          value={draft.denylistText}\n                          onChange={(event) => updateDraft(flag.key, 'denylistText', event.target.value)}\n                          placeholder=\"tenant ids\"\n                        />\n                      </TableCell>\n                      <TableCell>{flag.scope ?? (schoolId ? 'school' : 'organization')}</TableCell>\n                      <TableCell>\n                        <Button\n                          variant=\"outline\"\n                          onClick={() => handleSave(flag.key)}\n                          disabled={updateMutation.isLoading || !organizationId}\n                        >\n                          Save\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  );\n                })\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"],"names":["EMPTY_FLAGS","buildDraft","flag","joinList","AdminFeatureFlags","scope","useTenantScope","organizationId","schoolId","newKey","setNewKey","useState","newDescription","setNewDescription","drafts","setDrafts","flagsQuery","useQuery","fetchAdminFeatureFlags","updateMutation","useMutation","updateAdminFeatureFlag","useEffect","_a","next","groupedFlags","useMemo","updateDraft","key","field","value","prev","handleSave","draft","splitList","handleCreate","jsxs","jsx","Card","CardHeader","CardTitle","CardContent","Input","event","Button","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","Switch","checked"],"mappings":"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"}