import{b as A,G as B,r as i,j as e,C as c,i as u,k as x,o as g,B as O,y as _}from"./index-BPP-_OMN.js";import{u as P}from"./useMutation-CMiQkM4s.js";import{I as o}from"./input-DXyqFpUo.js";import{T as E}from"./textarea-Be6YKw6o.js";import{S as F}from"./switch-CC0KUM4c.js";function M(r){try{return r?JSON.parse(r):{}}catch{return{}}}function W(){const{data:r}=A(),a=(r==null?void 0:r.districtId)??null,m=(r==null?void 0:r.schoolId)??null,d=B({queryKey:["tenant_settings",a,m],enabled:!!a,queryFn:async()=>{var n;return((n=(await _.request(`query TenantSettings($districtId: uuid!, $schoolId: uuid) {
        tenant_settings(
          where: {
            district_id: { _eq: $districtId },
            _or: [
              { school_id: { _eq: $schoolId } },
              { school_id: { _is_null: true } }
            ]
          },
          order_by: { school_id: desc_nulls_last }
        ) {
          id
          district_id
          school_id
          name
          branding
          settings
          updated_at
        }
      }`,{districtId:a,schoolId:m})).tenant_settings)==null?void 0:n[0])??null}}),[h,p]=i.useState(""),[v,S]=i.useState(""),[y,b]=i.useState("#111827"),[f,N]=i.useState("#3b82f6"),[q,C]=i.useState("{}"),[w,I]=i.useState("365"),[R,D]=i.useState("30"),[T,$]=i.useState(!1);i.useMemo(()=>{var L,J,k;const s=d.data;if(!s)return;p(s.name??""),S(((L=s.branding)==null?void 0:L.logo_url)??""),b(((J=s.branding)==null?void 0:J.primary_color)??"#111827"),N(((k=s.branding)==null?void 0:k.accent_color)??"#3b82f6");const t=s.settings??{},n=t.retention??{};I(String(n.audit_log_days??n.auditLogDays??"365")),D(String(n.dsar_export_days??n.dsarExportDays??"30")),C(JSON.stringify(t,null,2));const j=t.require_sso!==void 0?t.require_sso:t.requireSso!==void 0?t.requireSso:!1;$(!!j)},[d.data]);const l=P({mutationFn:async()=>{var n;if(!a)throw new Error("Missing district scope");const s={logo_url:v||null,primary_color:y||null,accent_color:f||null},t=M(q);t.retention={...t.retention,audit_log_days:Number(w)||365,dsar_export_days:Number(R)||30},t.require_sso=!!T,(n=d.data)!=null&&n.id?await _.request(`mutation UpdateTenantSettings($id: uuid!, $changes: tenant_settings_set_input!) {
          update_tenant_settings_by_pk(pk_columns: { id: $id }, _set: $changes) { id updated_at }
        }`,{id:d.data.id,changes:{name:h,branding:s,settings:t}}):await _.request(`mutation InsertTenantSettings($object: tenant_settings_insert_input!) {
          insert_tenant_settings_one(object: $object) { id }
        }`,{object:{district_id:a,school_id:m,name:h,branding:s,settings:t}})},onSuccess:()=>d.refetch()});return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Tenant Settings"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure district / school-level branding and settings. Stored in Hasura + enforced with DB RLS."})]}),e.jsxs(c,{children:[e.jsx(u,{children:e.jsx(x,{children:"Scope"})}),e.jsxs(g,{className:"text-sm space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"District:"})," ",e.jsx("span",{className:"font-mono",children:a??"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"School:"})," ",e.jsx("span",{className:"font-mono",children:m??"—"})]})]})]}),e.jsxs(c,{children:[e.jsx(u,{children:e.jsx(x,{children:"Branding"})}),e.jsxs(g,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Tenant name"}),e.jsx(o,{value:h,onChange:s=>p(s.target.value),placeholder:"Paterson Public Schools"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Logo URL"}),e.jsx(o,{value:v,onChange:s=>S(s.target.value),placeholder:"https://.../logo.png"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Primary color"}),e.jsx(o,{value:y,onChange:s=>b(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Accent color"}),e.jsx(o,{value:f,onChange:s=>N(s.target.value)})]})]})]}),e.jsxs(c,{children:[e.jsx(u,{children:e.jsx(x,{children:"Identity & SSO"})}),e.jsxs(g,{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{id:"require-sso",checked:T,onCheckedChange:s=>$(s)}),e.jsx("label",{htmlFor:"require-sso",className:"text-sm",children:"Require users to sign in via single sign-on"})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"When enabled, all users will be redirected to an enabled SSO provider and email/password login will be disabled."})]})]}),e.jsxs(c,{children:[e.jsx(u,{children:e.jsx(x,{children:"Settings JSON"})}),e.jsxs(g,{children:[e.jsx(E,{value:q,onChange:s=>C(s.target.value),rows:10}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx(O,{onClick:()=>l.mutate(),disabled:l.isLoading||!a,children:l.isLoading?"Saving…":"Save"})}),l.error?e.jsx("div",{className:"mt-2 text-sm text-red-600",children:String(l.error)}):null]})]}),e.jsxs(c,{children:[e.jsx(u,{children:e.jsx(x,{children:"Retention Policy"})}),e.jsxs(g,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Audit log retention (days)"}),e.jsx(o,{type:"number",min:"1",value:w,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"DSAR export retention (days)"}),e.jsx(o,{type:"number",min:"1",value:R,onChange:s=>D(s.target.value)})]}),e.jsx("p",{className:"text-xs text-muted-foreground md:col-span-2",children:"Retention settings override the JSON payload on save and are used by the automated purge job."})]})]})]})}export{W as default};
//# sourceMappingURL=AdminTenantSettings-D_TL4UF2.js.map
