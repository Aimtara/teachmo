import{A as W,T as X,r as l,j as e,N as Z,L as ee,D as se,E as c}from"./index-BPP-_OMN.js";import{O as x,l as te,a as ae,c as re,e as le}from"./commandCenter-BFr7izyb.js";const v=["queued","approved","running","done","failed","canceled"];function q({status:r}){const d=r==="queued"?"bg-gray-100 text-gray-900":r==="approved"?"bg-blue-100 text-blue-900":r==="running"?"bg-amber-100 text-amber-900":r==="done"?"bg-green-100 text-green-900":r==="failed"?"bg-red-100 text-red-900":"bg-gray-100 text-gray-700";return e.jsx("span",{className:`inline-flex rounded-full px-2 py-1 text-xs font-medium ${d}`,children:r})}function D({type:r}){const d=r===x.RUNBOOK_CREATE?"Runbook":r===x.ESCALATE?"Escalate":r===x.ROLLBACK?"Rollback":r,o=r===x.ROLLBACK?"bg-red-50 text-red-900":r===x.ESCALATE?"bg-amber-50 text-amber-900":"bg-indigo-50 text-indigo-900";return e.jsx("span",{className:`inline-flex rounded-full px-2 py-1 text-xs font-medium ${o}`,children:d})}function M({value:r}){const d=l.useMemo(()=>{try{return JSON.stringify(r??{},null,2)}catch{return String(r)}},[r]);return e.jsx("pre",{className:"max-h-64 overflow-auto rounded-lg border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800",children:d})}function de(){var L,T,O,k,_;const{isAuthenticated:r}=W(),d=X(),o=d==null?void 0:d.id,[j,w]=l.useState(!0),[g,A]=l.useState(null),[p,K]=l.useState([]),[u,S]=l.useState(null),[m,U]=l.useState("active"),[y,$]=l.useState("all"),[b,I]=l.useState(""),[f,C]=l.useState(!1),[N,J]=l.useState([]),h=async()=>{w(!0);try{const s=await te(),t=(s==null?void 0:s.orchestrator_actions)??[];K(t),A(null),!u&&t.length>0&&S(t[0].id)}catch(s){console.error(s),A(s)}finally{w(!1)}},E=async s=>{if(s){C(!0);try{const t=await se({entityType:"orchestrator_actions",entityId:s,limit:80});J((t==null?void 0:t.audit_log)??[])}catch(t){console.error(t),c.error(t.message||"Failed to load audit log")}finally{C(!1)}}};l.useEffect(()=>{r&&h()},[r]),l.useEffect(()=>{u&&E(u)},[u]);const P=l.useMemo(()=>{const s={};for(const t of p)s[t.status]=(s[t.status]||0)+1;return{byStatus:s}},[p]),R=l.useMemo(()=>{const s=b.trim().toLowerCase(),t=new Set(["queued","approved","running"]);return p.filter(n=>m==="active"?t.has(n.status):m==="all"?!0:n.status===m).filter(n=>y==="all"?!0:n.type===y).filter(n=>{if(!s)return!0;const i=n.epic;return(n.type||"").toLowerCase().includes(s)||(n.status||"").toLowerCase().includes(s)||((i==null?void 0:i.code)||"").toLowerCase().includes(s)||((i==null?void 0:i.title)||"").toLowerCase().includes(s)}).sort((n,i)=>{const B=v.indexOf(n.status),F=v.indexOf(i.status);return B!==F?B-F:new Date(i.created_at).getTime()-new Date(n.created_at).getTime()})},[p,m,y,b]),a=l.useMemo(()=>p.find(s=>s.id===u)??null,[p,u]),H=s=>s&&s.status==="queued",Q=s=>s&&s.status==="approved",V=s=>s&&["queued","approved"].includes(s.status),Y=async s=>{if(!o)return c.error("Missing actor id");try{await ae(s.id,o),c.success("Approved"),await h()}catch(t){console.error(t),c.error(t.message||"Failed to approve")}},z=async s=>{if(!o)return c.error("Missing actor id");try{await re(s.id,o),c.success("Canceled"),await h()}catch(t){console.error(t),c.error(t.message||"Failed to cancel")}},G=async s=>{if(!o)return c.error("Missing actor id");try{await le(s,o),c.success("Executed"),await h()}catch(t){console.error(t),c.error(t.message||"Failed to execute")}};return r?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-semibold text-gray-900",children:"Command Center"}),e.jsx("p",{className:"text-gray-600",children:"Approve and execute operational actions generated from the Execution Board."})]}),e.jsx("button",{onClick:h,className:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm hover:bg-gray-50",children:"Refresh"})]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-6",children:v.map(s=>e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-xs text-gray-500",children:s}),e.jsx("p",{className:"text-2xl font-semibold",children:P.byStatus[s]||0})]},s))})]}),e.jsxs("section",{className:"grid gap-4 lg:grid-cols-[1.1fr_0.9fr]",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("input",{value:b,onChange:s=>I(s.target.value),placeholder:"Search actions (epic code/title, status, type)…",className:"w-full md:w-96 border rounded-lg px-3 py-2"}),e.jsxs("select",{value:m,onChange:s=>U(s.target.value),className:"border rounded-lg px-3 py-2",children:[e.jsx("option",{value:"active",children:"Active (queued/approved/running)"}),e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"queued",children:"Queued"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"running",children:"Running"}),e.jsx("option",{value:"done",children:"Done"}),e.jsx("option",{value:"failed",children:"Failed"}),e.jsx("option",{value:"canceled",children:"Canceled"})]}),e.jsxs("select",{value:y,onChange:s=>$(s.target.value),className:"border rounded-lg px-3 py-2",children:[e.jsx("option",{value:"all",children:"All types"}),e.jsx("option",{value:x.RUNBOOK_CREATE,children:"Runbook"}),e.jsx("option",{value:x.ESCALATE,children:"Escalate"}),e.jsx("option",{value:x.ROLLBACK,children:"Rollback"})]})]})}),e.jsx("div",{className:"overflow-x-auto rounded-xl border border-gray-200 bg-white shadow-sm",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Created"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Epic"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Type"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Status"})]})}),e.jsxs("tbody",{children:[j&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-3 text-gray-600",colSpan:4,children:"Loading actions…"})}),g&&e.jsx("tr",{children:e.jsxs("td",{className:"px-3 py-3 text-red-600",colSpan:4,children:["Failed to load. ",g.message]})}),!j&&!g&&R.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-3 text-gray-500",colSpan:4,children:"No actions match these filters."})}),!j&&!g&&R.map(s=>{var t,n;return e.jsxs("tr",{className:`border-t cursor-pointer hover:bg-gray-50 ${s.id===u?"bg-gray-50":""}`,onClick:()=>S(s.id),children:[e.jsx("td",{className:"px-3 py-2 text-xs text-gray-600",children:new Date(s.created_at).toLocaleString()}),e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-mono text-xs text-gray-700",children:((t=s.epic)==null?void 0:t.code)||"—"}),e.jsx("div",{className:"text-sm font-medium text-gray-900",children:((n=s.epic)==null?void 0:n.title)||"No epic"})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(D,{type:s.type})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx(q,{status:s.status})})]},s.id)})]})]})})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-5 shadow-sm space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Action details"}),((L=a==null?void 0:a.epic)==null?void 0:L.code)&&e.jsx(ee,{to:`/admin/execution-board?q=${encodeURIComponent(a.epic.code)}`,className:"text-sm text-blue-700 hover:underline",children:"View in Execution Board"})]}),a&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>Y(a),disabled:!H(a),className:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs shadow-sm hover:bg-gray-50 disabled:opacity-50",children:"Approve"}),e.jsx("button",{onClick:()=>G(a),disabled:!Q(a),className:"rounded-lg bg-gray-900 text-white px-3 py-2 text-xs shadow-sm hover:bg-gray-800 disabled:opacity-50",children:"Execute"}),e.jsx("button",{onClick:()=>z(a),disabled:!V(a),className:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs shadow-sm hover:bg-gray-50 disabled:opacity-50",children:"Cancel"})]})]}),!a&&e.jsx("p",{className:"text-sm text-gray-600",children:"Select an action to see details."}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(D,{type:a.type}),e.jsx(q,{status:a.status}),((T=a.epic)==null?void 0:T.tag)&&e.jsx("span",{className:"inline-flex rounded-full bg-gray-100 px-2 py-1 text-xs text-gray-800",children:a.epic.tag})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Payload"}),e.jsx(M,{value:a.payload})]}),a.result&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Result"}),e.jsx(M,{value:a.result})]}),a.error&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Error"}),e.jsx("pre",{className:"rounded-lg border border-red-200 bg-red-50 p-3 text-xs text-red-900",children:a.error})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Runbooks"}),e.jsx("p",{className:"text-sm font-medium",children:((O=a.runbooks)==null?void 0:O.length)||0})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Escalations"}),e.jsx("p",{className:"text-sm font-medium",children:((k=a.escalations)==null?void 0:k.length)||0})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-3",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Rollbacks"}),e.jsx("p",{className:"text-sm font-medium",children:((_=a.rollbacks)==null?void 0:_.length)||0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Audit trail"}),e.jsx("button",{onClick:()=>E(a.id),className:"text-xs text-blue-700 hover:underline",children:"Refresh"})]}),f&&e.jsx("p",{className:"text-sm text-gray-600",children:"Loading audit…"}),!f&&N.length===0&&e.jsx("p",{className:"text-sm text-gray-600",children:"No audit entries found for this action."}),!f&&N.length>0&&e.jsx("div",{className:"max-h-64 overflow-auto rounded-lg border border-gray-200",children:e.jsx("ul",{className:"divide-y",children:N.map(s=>e.jsxs("li",{className:"p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-mono text-gray-700",children:s.action}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleString()})]}),s.metadata&&Object.keys(s.metadata||{}).length>0&&e.jsx("pre",{className:"mt-2 max-h-28 overflow-auto rounded bg-gray-50 p-2 text-[11px] text-gray-700",children:JSON.stringify(s.metadata,null,2)})]},s.id))})})]})]})]})]})]}):e.jsx(Z,{to:"/",replace:!0})}export{de as default};
//# sourceMappingURL=AdminCommandCenter-5JsCWwpD.js.map
