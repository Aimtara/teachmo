{"version":3,"file":"onboarding-C5j826Dm.js","sources":["../../src/domains/onboarding.js"],"sourcesContent":["import { graphqlRequest } from '@/lib/graphql';\n\nexport async function bootstrapOrganization({ organizationName, schoolName }) {\n  // Only privileged roles can create organizations/schools (Hasura permissions enforce this).\n  // Keep this two-step so the school always has a real organization_id.\n  const orgQuery = `mutation UpsertOrganization($name: String!) {\n    organization: insert_organizations_one(\n      object: { name: $name }\n      on_conflict: { constraint: organizations_name_key, update_columns: [name] }\n    ) {\n      id\n      name\n    }\n  }`;\n\n  const orgData = await graphqlRequest({\n    query: orgQuery,\n    variables: { name: organizationName }\n  });\n\n  const organization = orgData?.organization ?? null;\n  if (!organization?.id) {\n    return { organization: null, school: null };\n  }\n\n  const schoolQuery = `mutation UpsertSchool($orgId: uuid!, $name: String!) {\n    school: insert_schools_one(\n      object: { organization_id: $orgId, name: $name }\n      on_conflict: { constraint: schools_organization_id_name_key, update_columns: [name, timezone] }\n    ) {\n      id\n      name\n      organization_id\n    }\n  }`;\n\n  const schoolData = await graphqlRequest({\n    query: schoolQuery,\n    variables: { orgId: organization.id, name: schoolName }\n  });\n\n  return {\n    organization,\n    school: schoolData?.school ?? null\n  };\n}\n\nexport async function completeOnboarding({\n  userId,\n  fullName,\n  organizationId,\n  schoolId,\n  allowTenantWrite = false\n}) {\n  if (!userId) throw new Error('Missing userId');\n  if (!fullName) throw new Error('Missing fullName');\n\n  const insertQuery = `mutation InsertMyProfile($input: profiles_insert_input!) {\n    insert_profiles_one(object: $input) {\n      id\n      user_id\n      full_name\n      app_role\n      organization_id\n      school_id\n    }\n  }`;\n\n  try {\n    const insertData = await graphqlRequest({\n      query: insertQuery,\n      variables: { input: { full_name: fullName } }\n    });\n\n    if (insertData?.insert_profiles_one) {\n      return insertData.insert_profiles_one;\n    }\n  } catch (error) {\n    // Fall through to update when the profile already exists.\n  }\n\n  const updateQuery = allowTenantWrite\n    ? `mutation UpdateMyProfileTenant($userId: uuid!, $fullName: String!, $orgId: uuid, $schoolId: uuid) {\n        update_profiles(\n          where: { user_id: { _eq: $userId } }\n          _set: { full_name: $fullName, organization_id: $orgId, school_id: $schoolId }\n        ) {\n          returning {\n            id\n            user_id\n            full_name\n            app_role\n            organization_id\n            school_id\n          }\n        }\n      }`\n    : `mutation UpdateMyProfileBasics($userId: uuid!, $fullName: String!) {\n        update_profiles(\n          where: { user_id: { _eq: $userId } }\n          _set: { full_name: $fullName }\n        ) {\n          returning {\n            id\n            user_id\n            full_name\n            app_role\n            organization_id\n            school_id\n          }\n        }\n      }`;\n\n  const updateVars = allowTenantWrite\n    ? { userId, fullName, orgId: organizationId ?? null, schoolId: schoolId ?? null }\n    : { userId, fullName };\n\n  const updateData = await graphqlRequest({\n    query: updateQuery,\n    variables: updateVars\n  });\n\n  return updateData?.update_profiles?.returning?.[0] ?? null;\n}\n"],"names":["bootstrapOrganization","organizationName","schoolName","orgData","graphqlRequest","organization","schoolData","completeOnboarding","userId","fullName","organizationId","schoolId","allowTenantWrite","insertQuery","insertData","updateData","_b","_a"],"mappings":"wCAEO,eAAeA,EAAsB,CAAE,iBAAAC,EAAkB,WAAAC,GAAc,CAa5E,MAAMC,EAAU,MAAMC,EAAe,CACnC,MAXe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAYf,UAAW,CAAE,KAAMH,CAAgB,CACvC,CAAG,EAEKI,GAAeF,GAAA,YAAAA,EAAS,eAAgB,KAC9C,GAAI,EAACE,GAAA,MAAAA,EAAc,IACjB,MAAO,CAAE,aAAc,KAAM,OAAQ,IAAI,EAc3C,MAAMC,EAAa,MAAMF,EAAe,CACtC,MAZkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAalB,UAAW,CAAE,MAAOC,EAAa,GAAI,KAAMH,CAAU,CACzD,CAAG,EAED,MAAO,CACL,aAAAG,EACA,QAAQC,GAAA,YAAAA,EAAY,SAAU,IAClC,CACA,CAEO,eAAeC,EAAmB,CACvC,OAAAC,EACA,SAAAC,EACA,eAAAC,EACA,SAAAC,EACA,iBAAAC,EAAmB,EACrB,EAAG,SACD,GAAI,CAACJ,EAAQ,MAAM,IAAI,MAAM,gBAAgB,EAC7C,GAAI,CAACC,EAAU,MAAM,IAAI,MAAM,kBAAkB,EAEjD,MAAMI,EAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAWpB,GAAI,CACF,MAAMC,EAAa,MAAMV,EAAe,CACtC,MAAOS,EACP,UAAW,CAAE,MAAO,CAAE,UAAWJ,CAAQ,CAAE,CACjD,CAAK,EAED,GAAIK,GAAA,MAAAA,EAAY,oBACd,OAAOA,EAAW,mBAEtB,MAAgB,CAEhB,CAsCA,MAAMC,EAAa,MAAMX,EAAe,CACtC,MArCkBQ,EAChB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAeA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAsBF,UANiBA,EACf,CAAE,OAAAJ,EAAQ,SAAAC,EAAU,MAAOC,GAAkB,KAAM,SAAUC,GAAY,IAAI,EAC7E,CAAE,OAAAH,EAAQ,SAAAC,CAAQ,CAKxB,CAAG,EAED,QAAOO,GAAAC,EAAAF,GAAA,YAAAA,EAAY,kBAAZ,YAAAE,EAA6B,YAA7B,YAAAD,EAAyC,KAAM,IACxD"}