{"version":3,"file":"messaging-Bk5WiIRk.js","sources":["../../src/api/adapters/modules/messaging.ts"],"sourcesContent":["import { nhost } from '@/lib/nhostClient';\nimport { graphql } from '@/lib/graphql';\n\nconst REQUEST_FIELDS = `\n  id\n  school_id\n  district_id\n  requester_user_id\n  target_user_id\n  status\n  reason\n  created_at\n  decided_at\n  decided_by\n  expires_at\n  metadata\n`;\n\nconst THREAD_FIELDS = `\n  id\n  school_id\n  district_id\n  requester_user_id\n  target_user_id\n  request_id\n  status\n  created_at\n  last_message_preview\n  request { id status }\n`;\n\nconst MESSAGE_FIELDS = `\n  id\n  thread_id\n  sender_id\n  sender_user_id\n  body\n  created_at\n  flagged\n  flag_reason\n`;\n\ntype FunctionEnvelope<T> = { data?: T } | T;\n\ntype SendMessageResponse = FunctionEnvelope<{ ok: boolean; messageId?: string | null }>;\ntype RequestAccessResponse = FunctionEnvelope<{ ok: boolean; requestId?: string | null }>;\ntype ApproveRequestResponse = FunctionEnvelope<{ ok: boolean; threadId?: string | null }>;\n\nexport async function requestMessagingAccess(input: { schoolId: string; targetUserId: string; note?: string }) {\n  const { res, error } = await nhost.functions.call('request-messaging-access', input);\n  if (error) throw error;\n  const payload = (res as RequestAccessResponse)?.data ?? (res as RequestAccessResponse);\n  return payload;\n}\n\nexport async function approveMessagingRequest(input: { requestId: string; approve: boolean; reason?: string }) {\n  const { res, error } = await nhost.functions.call('approve-messaging-request', input);\n  if (error) throw error;\n  const payload = (res as ApproveRequestResponse)?.data ?? (res as ApproveRequestResponse);\n  return payload;\n}\n\nexport async function sendMessage(input: { threadId: string; body: string }) {\n  const { res, error } = await nhost.functions.call('send-message', input);\n  if (error) throw error;\n  const payload = (res as SendMessageResponse)?.data ?? (res as SendMessageResponse);\n  return payload;\n}\n\ntype RequestFilter = {\n  status?: { _eq: string };\n};\n\nexport async function listRequests(params: { status?: string } = {}) {\n  const where: RequestFilter = {};\n  if (params.status) where.status = { _eq: params.status };\n\n  const data = await graphql(\n    `query MessagingRequests($where: messaging_requests_bool_exp) {\n      messaging_requests(where: $where, order_by: { created_at: desc }, limit: 50) { ${REQUEST_FIELDS} }\n    }`,\n    { where }\n  );\n\n  return data?.messaging_requests ?? [];\n}\n\nexport async function listThreads() {\n  const data = await graphql(\n    `query MessageThreads {\n      message_threads(order_by: { created_at: desc }) { ${THREAD_FIELDS} }\n    }`\n  );\n\n  return data?.message_threads ?? [];\n}\n\nexport async function listMessages(threadId: string, limit = 100) {\n  const data = await graphql(\n    `query Messages($threadId: uuid!, $limit: Int!) {\n      messages(where: { thread_id: { _eq: $threadId } }, order_by: { created_at: asc }, limit: $limit) {\n        ${MESSAGE_FIELDS}\n      }\n    }`,\n    { threadId, limit }\n  );\n\n  return data?.messages ?? [];\n}\n"],"names":["REQUEST_FIELDS","requestMessagingAccess","input","res","error","nhost","approveMessagingRequest","listRequests","params","where","data","graphql"],"mappings":"+CAGA,MAAMA,EAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EA6CvB,eAAsBC,EAAuBC,EAAkE,CAC7G,KAAM,CAAE,IAAAC,EAAK,MAAAC,GAAU,MAAMC,EAAM,UAAU,KAAK,2BAA4BH,CAAK,EACnF,GAAIE,EAAO,MAAMA,EAEjB,OADiBD,GAAA,YAAAA,EAA+B,OAASA,CAE3D,CAEA,eAAsBG,EAAwBJ,EAAiE,CAC7G,KAAM,CAAE,IAAAC,EAAK,MAAAC,GAAU,MAAMC,EAAM,UAAU,KAAK,4BAA6BH,CAAK,EACpF,GAAIE,EAAO,MAAMA,EAEjB,OADiBD,GAAA,YAAAA,EAAgC,OAASA,CAE5D,CAaA,eAAsBI,EAAaC,EAA8B,GAAI,CACnE,MAAMC,EAAuB,CAAA,EACzBD,EAAO,SAAQC,EAAM,OAAS,CAAE,IAAKD,EAAO,MAAA,GAEhD,MAAME,EAAO,MAAMC,EACjB;AAAA,uFACmFX,CAAc;AAAA,OAEjG,CAAE,MAAAS,CAAA,CAAM,EAGV,OAAOC,GAAA,YAAAA,EAAM,qBAAsB,CAAA,CACrC"}