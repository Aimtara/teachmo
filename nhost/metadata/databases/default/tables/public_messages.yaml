table:
  name: messages
  schema: public
object_relationships:
  - name: thread
    using:
      foreign_key_constraint_on: thread_id
select_permissions:
  - role: parent
    permission:
      columns:
        - id
        - thread_id
        - sender_id
        - sender_user_id
        - created_at
        - body
        - is_hidden
        - is_redacted
        - is_deleted
        - flagged
        - flag_reason
      filter:
        _and:
          - thread:
              _and:
                - _or:
                    - status: {_is_null: true}
                    - status: {_eq: "active"}
                - _or:
                    - participants:
                        user_id: {_eq: "X-Hasura-User-Id"}
                    - requester_user_id: {_eq: "X-Hasura-User-Id"}
                    - target_user_id: {_eq: "X-Hasura-User-Id"}
          - is_hidden: {_eq: false}
          - is_deleted: {_eq: false}
  - role: teacher
    permission:
      columns:
        - id
        - thread_id
        - sender_id
        - sender_user_id
        - created_at
        - body
        - is_hidden
        - is_redacted
        - is_deleted
        - flagged
        - flag_reason
      filter:
        _and:
          - thread:
              _and:
                - _or:
                    - status: {_is_null: true}
                    - status: {_eq: "active"}
                - _or:
                    - participants:
                        user_id: {_eq: "X-Hasura-User-Id"}
                    - requester_user_id: {_eq: "X-Hasura-User-Id"}
                    - target_user_id: {_eq: "X-Hasura-User-Id"}
          - is_hidden: {_eq: false}
          - is_deleted: {_eq: false}
  - role: school_admin
    permission:
      columns: "*"
      filter: {}
  - role: district_admin
    permission:
      columns: "*"
      filter: {}
  - role: admin
    permission:
      columns: "*"
      filter: {}
insert_permissions:
  - role: parent
    permission:
      columns:
        - thread_id
        - body
      check:
        _and:
          - sender_id: {_eq: "X-Hasura-User-Id"}
          - thread:
              _and:
                - _or:
                    - status: {_is_null: true}
                    - status: {_eq: "active"}
                - _or:
                    - participants:
                        user_id: {_eq: "X-Hasura-User-Id"}
                    - requester_user_id: {_eq: "X-Hasura-User-Id"}
                    - target_user_id: {_eq: "X-Hasura-User-Id"}
      set:
        sender_id: "X-Hasura-User-Id"
        sender_user_id: "X-Hasura-User-Id"
  - role: teacher
    permission:
      columns:
        - thread_id
        - body
      check:
        _and:
          - sender_id: {_eq: "X-Hasura-User-Id"}
          - thread:
              _and:
                - _or:
                    - status: {_is_null: true}
                    - status: {_eq: "active"}
                - _or:
                    - participants:
                        user_id: {_eq: "X-Hasura-User-Id"}
                    - requester_user_id: {_eq: "X-Hasura-User-Id"}
                    - target_user_id: {_eq: "X-Hasura-User-Id"}
      set:
        sender_id: "X-Hasura-User-Id"
        sender_user_id: "X-Hasura-User-Id"
update_permissions:
  - role: school_admin
    permission:
      columns:
        - is_hidden
        - hidden_by
        - hidden_reason
        - hidden_at
        - is_redacted
        - redacted_by
        - redacted_reason
        - redacted_at
        - is_deleted
        - deleted_by
        - deleted_reason
        - deleted_at
        - body
        - flagged
        - flag_reason
      filter: {}
      check: {}
      set:
        hidden_by: "X-Hasura-User-Id"
        redacted_by: "X-Hasura-User-Id"
        deleted_by: "X-Hasura-User-Id"
  - role: district_admin
    permission:
      columns:
        - is_hidden
        - hidden_by
        - hidden_reason
        - hidden_at
        - is_redacted
        - redacted_by
        - redacted_reason
        - redacted_at
        - is_deleted
        - deleted_by
        - deleted_reason
        - deleted_at
        - body
        - flagged
        - flag_reason
      filter: {}
      check: {}
      set:
        hidden_by: "X-Hasura-User-Id"
        redacted_by: "X-Hasura-User-Id"
        deleted_by: "X-Hasura-User-Id"
  - role: admin
    permission:
      columns:
        - is_hidden
        - hidden_by
        - hidden_reason
        - hidden_at
        - is_redacted
        - redacted_by
        - redacted_reason
        - redacted_at
        - is_deleted
        - deleted_by
        - deleted_reason
        - deleted_at
        - body
        - flagged
        - flag_reason
      filter: {}
      check: {}
      set:
        hidden_by: "X-Hasura-User-Id"
        redacted_by: "X-Hasura-User-Id"
        deleted_by: "X-Hasura-User-Id"
