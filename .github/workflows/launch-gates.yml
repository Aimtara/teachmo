name: launch-gates
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: launch-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  launch-gates:
    name: launch-gates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: test
      PORT: 4000
      AUTH_MODE: mock
      AUTH_MOCK_SECRET: launch-gates-secret
      NHOST_ADMIN_SECRET: launch-gates-admin-secret
      AUTH_JWKS_URL: https://example.invalid/.well-known/jwks.json
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/teachmo
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: teachmo
    services:
      postgres:
        image: postgres:14
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: teachmo
        options: >-
          --health-cmd="pg_isready -U postgres -d teachmo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # --------------------------------------------------------
      # G0: Secret Hygiene Scan
      # --------------------------------------------------------
      - name: G0 - Secret Hygiene Scan
        shell: bash
        run: |
          set -euo pipefail
          echo "Scanning for prohibited client-side secrets..."
          if grep -rE "VITE_OPS_ADMIN_KEY|x-ops-admin-key|OPS_ADMIN_KEY" src/; then
            echo "❌ FAILED: Found forbidden ops/admin key pattern in frontend code."
            exit 1
          fi
          if [ -f .env.example ]; then
            if grep -E "^VITE_.*(KEY|SECRET|PASSWORD|TOKEN)=" .env.example; then
              echo "❌ FAILED: .env.example contains a VITE_* variable that looks like a secret."
              exit 1
            fi
          fi
          echo "✅ G0 Secret Hygiene Passed."

      # --------------------------------------------------------
      # Install & Build
      # --------------------------------------------------------
      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (backend)
        working-directory: backend
        run: npm ci

      - name: Build frontend (for stable CI serving)
        run: npm run build

      - name: Wait for Postgres
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if (echo > /dev/tcp/"$DB_HOST"/"$DB_PORT") >/dev/null 2>&1; then
              echo "✅ Postgres is reachable on ${DB_HOST}:${DB_PORT}"
              exit 0
            fi
            echo "Waiting for Postgres at ${DB_HOST}:${DB_PORT}... (${i}/30)"
            sleep 2
          done
          echo "❌ Postgres did not become reachable at ${DB_HOST}:${DB_PORT}"
          exit 1

      # --------------------------------------------------------
      # G0: Backend Auth Tests (Unit)
      # --------------------------------------------------------
      - name: G0 - Backend Ops Auth Tests
        working-directory: backend
        run: npm run test:ops-auth

      # --------------------------------------------------------
      # Boot Backend + Frontend for E2E
      # --------------------------------------------------------
      - name: Start backend (CI)
        working-directory: backend
        run: |
          set -euo pipefail
          nohup npm run start > ../backend-ci.log 2>&1 &
          echo $! > ../backend-ci.pid

      - name: Start frontend (CI)
        env:
          PORT: 3000
          VITE_E2E_BYPASS_AUTH: "true"
          VITE_API_BASE_URL: "http://localhost:4000"
        run: |
          set -euo pipefail
          nohup npm run preview -- --host 0.0.0.0 --port 3000 > frontend-ci.log 2>&1 &
          echo $! > frontend-ci.pid

      - name: Wait for backend + frontend
        run: |
          npx wait-on http://localhost:4000/api/ops/health http://localhost:3000 --timeout 60000

      # --------------------------------------------------------
      # G3: Operational Readiness (E2E Smoke)
      # --------------------------------------------------------
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: G3 - Ops E2E Smoke Test
        env:
          BASE_URL: http://localhost:3000
          AUTH_MOCK_SECRET: launch-gates-secret
        run: |
          npm run e2e:ops

      # --------------------------------------------------------
      # Cleanup
      # --------------------------------------------------------
      - name: Cleanup & Logs
        if: always()
        run: |
          set +e
          if [ -f backend-ci.pid ]; then kill $(cat backend-ci.pid) || true; fi
          if [ -f frontend-ci.pid ]; then kill $(cat frontend-ci.pid) || true; fi
          echo "==== backend-ci.log ===="; tail -n 200 backend-ci.log || true
          echo "==== frontend-ci.log ===="; tail -n 200 frontend-ci.log || true
