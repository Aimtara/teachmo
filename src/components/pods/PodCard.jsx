import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { 
  Users, 
  Lock, 
  Globe, 
  School, 
  Clock,
  UserPlus,
  Settings,
  MoreHorizontal,
  Flag,
  Heart,
  MessageSquare
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { motion } from 'framer-motion';
import { useToast } from '@/components/ui/use-toast';
import { Pod, PodMember, JoinRequest } from '@/api/entities';
import { User } from '@/api/entities';

export default function PodCard({ pod, onJoin, onRequest, isJoined = false, isPendingApproval = false }) {
  const [isLoading, setIsLoading] = useState(false);
  const [memberCount, setMemberCount] = useState(pod.member_count || 0);
  const { toast } = useToast();

  const getTypeIcon = (type) => {
    switch (type) {
      case 'private': return Lock;
      case 'school': return School;
      default: return Globe;
    }
  };

  const getTypeColor = (type) => {
    switch (type) {
      case 'private': return 'bg-red-100 text-red-800';
      case 'school': return 'bg-blue-100 text-blue-800';
      default: return 'bg-green-100 text-green-800';
    }
  };

  const getActivityLevelColor = (level) => {
    switch (level) {
      case 'high': return 'bg-red-100 text-red-700';
      case 'medium': return 'bg-yellow-100 text-yellow-700';
      default: return 'bg-gray-100 text-gray-700';
    }
  };

  const handleJoinPod = async () => {
    if (isLoading) return;
    
    setIsLoading(true);
    try {
      const user = await User.me();
      
      if (pod.join_approval_required) {
        // Create join request
        await JoinRequest.create({
          pod_id: pod.id,
          user_id: user.id,
          status: 'pending',
          message: `Hi! I'd like to join the ${pod.name} pod.`
        });
        
        toast({
          title: "Join request sent",
          description: "Your request is pending approval from the pod owner.",
        });
        
        if (onRequest) onRequest(pod.id);
        
      } else {
        // Direct join
        await PodMember.create({
          pod_id: pod.id,
          user_id: user.id
        });
        
        // Update pod member count
        await Pod.update(pod.id, {
          member_count: memberCount + 1,
          last_activity_at: new Date().toISOString()
        });
        
        setMemberCount(prev => prev + 1);
        
        // Award points for joining community
        await User.updateMyUserData({
          points: (user.points || 0) + 3
        });
        
        toast({
          title: "Welcome to the pod! +3 points",
          description: `You've joined ${pod.name}`,
        });
        
        if (onJoin) onJoin(pod.id);
      }
      
    } catch (error) {
      console.error('Error joining pod:', error);
      toast({
        variant: "destructive",
        title: "Error",
        description: "Could not join pod. Please try again.",
      });
    } finally {
      setIsLoading(false);
    }
  };

  const formatTimeAgo = (dateString) => {
    if (!dateString) return 'No recent activity';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffInHours < 1) return 'Active now';
    if (diffInHours < 24) return `Active ${diffInHours}h ago`;
    if (diffInHours < 168) return `Active ${Math.floor(diffInHours / 24)}d ago`;
    return 'Less active';
  };

  const TypeIcon = getTypeIcon(pod.type);

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      className="h-full"
    >
      <Card className="bg-white border border-gray-200 hover:border-gray-300 transition-colors h-full flex flex-col">
        <CardHeader className="pb-3">
          <div className="flex items-start justify-between">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-2">
                <TypeIcon className="w-4 h-4 text-gray-500" />
                <Badge className={getTypeColor(pod.type)} variant="secondary">
                  {pod.type}
                </Badge>
                {pod.is_autogenerated && (
                  <Badge variant="outline" className="text-xs">
                    AI Suggested
                  </Badge>
                )}
              </div>
              <CardTitle className="text-lg font-semibold text-gray-900 mb-1 line-clamp-2">
                {pod.name}
              </CardTitle>
            </div>
            
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="sm" className="h-8 w-8 p-0">
                  <MoreHorizontal className="w-4 h-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem>
                  <Heart className="w-4 h-4 mr-2" />
                  Save pod
                </DropdownMenuItem>
                <DropdownMenuItem>
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Message owner
                </DropdownMenuItem>
                <DropdownMenuItem>
                  <Flag className="w-4 h-4 mr-2" />
                  Report pod
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
          
          {pod.description && (
            <p className="text-sm text-gray-600 line-clamp-3 mb-3">
              {pod.description}
            </p>
          )}
        </CardHeader>

        <CardContent className="pt-0 flex-1 flex flex-col">
          {/* Tags */}
          {pod.tags && pod.tags.length > 0 && (
            <div className="flex flex-wrap gap-1 mb-4">
              {pod.tags.slice(0, 3).map((tag, index) => (
                <span 
                  key={index}
                  className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full"
                >
                  #{tag}
                </span>
              ))}
              {pod.tags.length > 3 && (
                <span className="text-xs text-gray-400">
                  +{pod.tags.length - 3} more
                </span>
              )}
            </div>
          )}

          {/* Stats */}
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div className="flex items-center gap-2">
              <Users className="w-4 h-4 text-gray-400" />
              <span className="text-sm text-gray-600">
                {memberCount} {memberCount === 1 ? 'member' : 'members'}
              </span>
            </div>
            
            <div className="flex items-center gap-2">
              <Clock className="w-4 h-4 text-gray-400" />
              <Badge className={getActivityLevelColor(pod.activity_level)} variant="secondary">
                {pod.activity_level}
              </Badge>
            </div>
          </div>

          {/* Last Activity */}
          <p className="text-xs text-gray-500 mb-4">
            {formatTimeAgo(pod.last_activity_at)}
          </p>

          {/* Max Members Warning */}
          {pod.max_members && memberCount >= pod.max_members && (
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-2 mb-4">
              <p className="text-xs text-orange-700">
                Pod is full ({memberCount}/{pod.max_members} members)
              </p>
            </div>
          )}

          {/* Action Button */}
          <div className="mt-auto">
            {isJoined ? (
              <Button
                variant="outline"
                className="w-full"
                onClick={() => {
                  // Navigate to pod detail page
                  window.location.href = `/community/pod/${pod.id}`;
                }}
              >
                <MessageSquare className="w-4 h-4 mr-2" />
                View Pod
              </Button>
            ) : isPendingApproval ? (
              <Button variant="outline" className="w-full" disabled>
                <Clock className="w-4 h-4 mr-2" />
                Pending Approval
              </Button>
            ) : pod.max_members && memberCount >= pod.max_members ? (
              <Button variant="outline" className="w-full" disabled>
                Pod Full
              </Button>
            ) : (
              <Button
                onClick={handleJoinPod}
                disabled={isLoading}
                className="w-full bg-blue-600 hover:bg-blue-700"
              >
                {isLoading ? (
                  'Joining...'
                ) : (
                  <>
                    <UserPlus className="w-4 h-4 mr-2" />
                    {pod.join_approval_required ? 'Request to Join' : 'Join Pod'}
                  </>
                )}
              </Button>
            )}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  );
}